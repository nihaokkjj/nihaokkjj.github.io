<!DOCTYPE html><html lang="zn-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>MinVue | 荥晋</title><meta name="keywords" content="minVue"><meta name="author" content="匡思进"><meta name="copyright" content="匡思进"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="MinVue"><meta name="application-name" content="MinVue"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="MinVue"><meta property="og:url" content="https://kkksj.cn/posts/2025/04/Fronted/MinVue/4a7e677b.html"><meta property="og:site_name" content="荥晋"><meta property="og:description" content="进一步学习vue"><meta property="og:locale" content="zn-CN"><meta property="og:image" content="https://kkksj.cn/img/4.jpg"><meta property="article:author" content="匡思进"><meta property="article:tag"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://kkksj.cn/img/4.jpg"><meta name="description" content="进一步学习vue"><link rel="shortcut icon" href="/img/images.jpg"><link rel="canonical" href="https://kkksj.cn/posts/2025/04/Fronted/MinVue/4a7e677b.html"><link rel="preconnect" href="//cdn.cbd.int"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/swiper/swiper.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  linkPageTop: undefined,
  peoplecanvas: undefined,
  postHeadAiDescription: {"enable":true,"gptName":"AnZhiYu","mode":"local","switchBtn":false,"btnLink":"https://afdian.net/item/886a79d4db6711eda42a52540025c377","randomNum":3,"basicWordCount":1000,"key":"xxxx","Referer":"https://xx.xx/"},
  diytitle: {"enable":true,"leaveTitle":"w(ﾟДﾟ)w 不要走！再看看嘛！","backTitle":"♪(^∇^*)欢迎肥来！"},
  LA51: undefined,
  greetingBox: {"enable":true,"default":"你好啊, 人类👋","list":[{"greeting":"晚安😴","startTime":0,"endTime":5},{"greeting":"早上好鸭👋, 祝你一天好心情！","startTime":6,"endTime":9},{"greeting":"上午好👋, 状态很好，鼓励一下～","startTime":10,"endTime":10},{"greeting":"11点多啦, 在坚持一下就吃饭啦～","startTime":11,"endTime":11},{"greeting":"午安👋, 宝贝","startTime":12,"endTime":14},{"greeting":"🌈充实的一天辛苦啦！","startTime":14,"endTime":18},{"greeting":"19点喽, 奖励一顿丰盛的大餐吧🍔。","startTime":19,"endTime":19},{"greeting":"晚上好👋, 在属于自己的时间好好放松😌~","startTime":20,"endTime":24}]},
  twikooEnvId: '',
  commentBarrageConfig:undefined,
  music_page_default: "nav_music",
  root: '/',
  preloader: {"source":2},
  friends_vue_info: {"apiurl":null},
  navMusic: true,
  mainTone: {"mode":"api","api":"/img/images.jpg","cover_change":true},
  authorStatus: {"skills":["🤖️ 数码科技爱好者","🔍 分享与热心帮助","🔨 设计开发一条龙","🤝 专修交互与设计","🏃 脚踏实地行动派","🧱 团队小组发动机"]},
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    simplehomepage: true,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"copy":true,"copyrightEbable":false,"limitCount":50,"languages":{"author":"作者: 匡思进","link":"链接: ","source":"来源: 荥晋","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。","copySuccess":"复制成功，复制和转载请标注本文地址"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: undefined,
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: '荥晋',
  title: 'MinVue',
  postAI: '',
  pageFillDescription: 'Mini Vue, 前言, 一个场景里的概念：响应式数据、依赖、数据劫持、MVVM 和双向绑定, 又一个场景里的概念：观察者模式、依赖收集, 再一个场景里的概念：虚拟DOM和Diff算法, 准备开始, 实现核心能力, 实现：ViewModel层核心 Mue, 实现：发布者 Publisher, 实现：数据劫持者 Hijacker, 实现：观察者 Viewer, 实现：模板编译者 Compiler, ~~【废弃】实现性能优化~~, ~~实现：虚拟DOM~~, ~~实现：Diff算法~~, 实现更多场景, 1. 在多种模块化规范下使用Mud.js, 2. 比虚拟DOM更直接的内容更新办法, 3. 模块化, 初步实现, 多级调用, 性能优化, 5. 【TODO】更好的观察者模式, 6. 丰富语法, 7. 实现生命周期, 8. 更多生态, 测试点, 1. 内容插值语法, 2. 属性插值语法, 3. if系列, 4. for循环, 5. 组件化, 6. 兼容性前言在尝试读懂这篇文章之前请保证已经学习过面向对象基本知识基础基础并且有过一定的实践开发基础不然可能会有非常多的小问号如果不满足上述条件也可以试着读一读不必为其中不懂的内容感到焦虑后面都能学会的本文旨在教会读者实现一个精简版的很多的功能会被简化但是核心思想是相通的本文会尽可能通俗易懂避开的各种生僻特性我们先不说的事情让我们先通过一些场景了解一点前置知识和概念只需要知道大概是什么没必要咬文嚼字一个场景里的概念响应式数据依赖数据劫持和双向绑定看看这段代码我们希望这个关系恒成立变了但是却不会发生变化我们希望变化时能自动地变化而不是我们还需要手动赋值多此一举那么怎么实现呢这里有一种思路是设置一个角色专门监听的变化在察觉变化时能够通知发生变化这很容易做到为我们提供了一个监听的修改当修改时通知发生相应变化一开始变化后在中将普通数据变成响应式数据的过程就叫数据劫持而扮演的这个角色在下文中被称为数据劫持者回到中的操作是如何去修改视图的呢让我们再看看一个操作修改内容的例子获取当前内容修改内容重新赋值我们能不能将第步干掉重新赋值看上去太多此一举了结合上文和的关系相信大家应该是灵光一闪我们这里先抛出问题暂时不考虑其中具体的实现细节响应式数据指的是依赖变化时该数据会自动变化如上文的就是响应式数据则是其依赖响应式数据和其依赖总是能表达为是一种技术架构代表数据层代表视图层在这里则是代表的层次层会监听另外两层的变化在其中一个变化时使另外一个发生相应的变化即层将层和层进行了双向绑定且与互为依赖具体一点用户在输入框输入了层内存里与之关联的数据自动变为层通过代码修改内存的数据为层界面上与之关联的部分自动变为层通过建立架构实现了双向的响应式即双向绑定又一个场景里的概念观察者模式依赖收集上述片段中两个内使用了一个变量我们实现一下对变化的监听察觉到它发生变化的时机然后及时通知到两个的改变监听一旦变化就改变两个的值注意这里我们能进行通知是因为这个片段很简单我们能直接看到被使用的位置所以可以写像创建上文与的关系那样的代码但是如果我们的项目有无穷多处都依赖了那我们还能一个一个手动去实现每一个响应式数据吗所以我们面临一个问题怎么快速修改所有这里我们需要先学习业界大佬们总结的种设计模式之一观察者模式什么是观察者模式这个模式中一共有个角色发布者与观察者发布者好比一个主观察者就是的粉丝当发视频的时候粉丝就会第一时间收到通知让我们用代码表述一下我们的问题解决了怎么快速修改所有通过发布者通知所有观察者执行方法修改数据就实现了修改所有我们可以手动创建一个发布者但是新的问题是我们该怎么创建观察者让我们分析一下该怎么做就像是把大象放进冰箱一样凡事都只需要三步观察局势发现很多地方都使用了变量比如特殊标记这些的位置让被标记的变量成为观察者怎么标记呢那就是创造一种语法比如中的然后通过一些暴力巧妙的操作遍历所有找到其中格式满足的内容将其变成观察者即可同时我们会用巧妙的操作实现一种逻辑在观察者产生的时候它会主动关注发布者具体怎么操作我们后面再谈寻找被特殊标记的变量的过程就是依赖收集将标记变量转化为响应式的过程就是数据劫持至此我们实现了单向的响应式在的内容被修改时触发方法通知所有存在于片段里面的一起修改也就是完成了那双向绑定怎么实现呢有了上述的铺垫之后就非常简单了视图层层的变动主要是来自于用户的输入键盘输入鼠标点击等所以我们只需要监听一些用户操作事件就好比如当用户输入时让进行通知就行了代码示意如下用户在这里标签上进行输入省略一堆代码监听键盘输入一旦用户进行输入就让主把新的值告诉其他所有粉丝观察者再一个场景里的概念虚拟和算法让我们先来讲个故事某个疯狂星期四乐程的点外卖打开某团先点了一份黄金鸡块五分钟后觉得不够吃又点了一份吮指原味鸡再过了五分钟觉得有点渴于是又点了一杯肥宅快乐水这个故事给我们什么启发很明显这样多次操作下来需要支付多次配送费用显然不如一次性点完所有来得划算在中也是类似的引擎和处理的渲染引擎不在同一个进程下每当用去操作操作都需要开辟一个跨进程的通道这种操作开销不小看不懂没关系我们通俗一点说相当于和是不在同一个国家的要去处理相关的事情就得花大价钱买机票出国去做做完了又得买机票回来继续做自己的事情如果下次又有的事情要处理那么就又得买机票出国这种开销是昂贵的所以如果能先把要处理的统一记录下来之后一次性处理完就能节省许多不必要的开销而这种记录就是虚拟众所周知会被解析为树下图左侧对应就是右侧的树这个词严格来说指的是树其中每个节点就叫节点而元素专指标签但是口头上树节点这几个词经常混用并不做严格的区分我们为了更明确地表示区分在提到虚拟的语境下会把称为真实虚拟就是用代码表示上图右侧结构主要看标签那一块的表示就好了标签名标签的属性标签的内容的内容内容可以直接就是一个字符串所以后面需要区分是字符串还是标签之后每次先在自己家里把要做的改变记录好后面出国就能一次性把所有事情办完节省开销那么如何构建虚拟呢让我们一步一步考虑起初遍历所有真实产生上述结构当发送改变时比如新增删除了一些标签我们得先在虚拟记录这种改变这时候问题出现了我们怎么知道这种改变发生在虚拟的哪个位置又重新遍历所有真实节点产生新的结构吗这听上去开销也太大了甚至比我们使用虚拟前的情况还要大那这简直是得不偿失所以我们需要一些算法来优化一下也就是算法算法不是具体某个算法而是像一样是一类算法解决的问题是如何尽快找出两份内容中不同的部分准备开始在了解了上面所有概念之后我们最后来进行一点总结我们要做的是所以简称为吧在正式开始之前希望大家能先去体验一下真正的由于的语法模仿的是所以推荐大家选择进行体验因为语法发生了一些变化可能会给大家带来一些困扰但无论什么版本底层原理还是基本一致的体验到什么程度只需要看看大概长啥样自己再写一点响应式数据试一下就行了让我们梳理一下上面三个场景中提到的内容整体流程大概是这样的其中需要注意的是我们之前提到的观察者模式中没有实现反向通知的能力这点会在下文提及让我们准备一下文件结构其中和中的内容分别是如果一切顺利中出现的将被替换成和上文一样接下来涉及到面向对象的部分我们都用进行实现中本质是这意味着可以用实现并且这是更推荐的做法但是考虑到大家的面向对象基础更多来自于用实现应该更容易上手实现核心能力实现层核心非常简单主要是记录一下和即对应的真实节点后续我们将把整个项目挂载到上然后创建数据劫持者和模板编译者即可的简写作为项目挂载的根节点把整个都传给实现发布者比较简单基本和之前提到的部分一致不再过多赘述发布者实现数据劫持者考虑到大家的基础我们这里先简单说明一个的知识点指向本文的目的不是学习所以只做不严谨且粗略的介绍如果你已经弄懂了请跳过这个部分上文已经用到过不少了看到这里相信也也应该知道中的大部分时候的意思就是我自己我们上文也提到了本质是而且内部也有大部分情况下一个函数的指向这个函数的调用者来看看下面这个例子类的方法全局函数浏览器环境下因为这是的缩写类的方法中使用全局函数浏览器环境下因为还是为了让类的方法中使用的全局函数访问到类的我们需要这么改这里多开一个变量的确是不必要的这里这么做是为了强调这种处理方式另外数据劫持还需要注意一个事情就是可能出现下面这样树形的数据所以我们需要进行一个遍历处理这里我们采用递归实现好了现在让我们来实现数据劫持者劫持数据需要拿到该数据节点及其父级对象创建发布者当前节点是树递归当前节点是叶子节点则是其父级节点上文提到的知识点的指向开始劫持数据记住这个这个很重要实现反向通知的核心步骤具体怎么回事在实现时进一步说明防止死循环更新触发更新提防一首新的数据是树形结构递归一下实现观察者观察者也非常容易实现只需要在之前提到过的代码上加一点点内容实现反向通知即可观察者传说中的层即实例数据的键用来更新视图层层的方法这里是反向通知的关键操作绑定一个静态属性相当于在内部创建一个全局变量记录是哪个观察者触发的反向通知这里使用了将触发劫持者设置的方法反向通知邀请当前这个成为观察者也可以理解为主动成为观察者结束标记为空释放内存同样地没有更新就啥也不干更新视图实现让我们分析一下其中是一个什么操作在创建的时候会给添加一个静态属性记录一下当前是在创建哪个观察者静态属性可以理解为在上创建的一个全局变量然后使用这个观察者对应的值时会触发方法让观察者实例将刚刚记录的观察者添加进观察者队列看上去就像是观察者一创建就主动关注了发布者一样这里其实有个有意思的小知识点就顺口提一句的内容是原数据的引用而不是拷贝所以我们可以在引入的上绑定新的值然后在中访问到这些值实现模板编译者这个是五个角色中最难的一个部分了在开始写代码前我们仍然需要介绍一堆前置概念首先我们要复习一下的类型请记住也是有类型的常见的类型如下表所示类型说明编号图示参考元素每一个标签都是一个元素节点如属性等文本元素节点或属性节点中的文本内容注释注释比如文档也叫根节点即然后再让我们了解一下伪数组伪数组也叫类数组本质是对象只不过键是就像是下面这样什么场景下会出现伪数组比如的返回值函数的参数列表等都是伪数组如果要把伪数组变为数组可以使用方法获取当前节点的所有子节点可以以此进行前序遍历伪数组真数组那为什么要把伪数组转为真数组呢因为伪数组是对象不具有数组的某些方法比如和许多场景下使用起来不方便那设计者为什么要搞出伪数组这种东西据之父自己坦白当初只用了十天就搞完了现在看起来确实设计得太糙了最后我们需要简单认识一下正则表达式实现只会简单用到一点正则所以这里只给出种给大家了解一下概念不做过多深入正则表达式这个能够匹配形如的字符串表示要获取的部分这是用正则表达式去匹配字符串用字符串去匹配正则表达式这是替换匹配内容这是由于主题是而且正则又博大精深所以限于篇幅此处不做更多介绍了如果对此感兴趣可以学习该类型的内容暂不支持下载熟悉了以上内容后先来大体看看我们要做的东西内容比较多我们拆成了几个层次分开看首先我们需要一个大体的框架如下模板编译者开始编译真实伪数组转为真数组进而可以用数组的前序遍历整个树判断是什么类型的扔给不同的处理方法元素类型文本类型如果还有子节点递归获取下一层主要就是实现这俩函数处理元素类型处理文本类型怎么实现函数呢既然我们都说过正则匹配了那么也会用上吧处理元素类型正则表达式匹配形如的字符串将节点的所有属性处理为数组遍历数组处理每个属性比如就是就是如果包含形如的部分比如匹配的是就是创建观察者触发相关逻辑将替换为具体的值监听键盘输入完成双向绑定处理文本类型与上面的方法基本上一样的逻辑至此已经基本完成了可以打开页面体验一下成果了但也再额外给一点开放性挑战感兴趣可以做一做当值为布尔或可以类型转换为布尔时进行相应的渲染控制循环渲染其中是一个数组是其元素是其下标废弃实现性能优化我们不需要下述的性能优化方案因为我们有了超越虚拟性能的方案实现虚拟经过一番体验后就发现如果非常快速地输入中文的话可能会导致双向绑定出错这是因为目前我们是每输入一个字符都会触发一次真实的更改高频且大量的操作就可能超出浏览器处理数据的极限输入频率超过浏览器最大渲染频率出现数据和视图不一致的情况总结就是太卡了需要优化一下那么就像是我们上文提到的实现一下虚拟实现算法如果我们没有虚拟那么我们或许可以不使用算法实现更多场景我突然意识到这不仅是一次尝试更是一个开发真实可用的框架的好机会由于名字寓意太明显了抄袭痕迹太重所以正式版改名叫吧寓意非常丰富实现思路借鉴了等多个框架是各种东西糊成的一坨实现并不精致但是容易被塑造成各种形状朴素实用泥巴里面可以催生出很多东西以此为基础可以产生更多技术框架出淤泥而不染我的确是在自吹自擂在多种模块化规范下使用先简单介绍一下的模块化规范规范名称说明示例几乎是前端诞生以来就有了雏形但是一直到年左右才终于形成正式的规范像这样引入的就是包的伴生产物也是年左右形成的规范像这样的导入导出的则是包官方年推出的规范正统像这样导入导出的则是包和年前后出现现如今使用频率较低不在本次兼容的范围内不详我们将借助的能力实现一套代码转变为多种规范的包在这之前你一定听说过或者不使用这些是因为它们太重了我们这里只是需要简单地转变规范所以轻量小巧的就成了首选相信配置一套满足上述要求的文件不会困扰大家所以交由大家自行实现在打包完成后引入不同规范的包非常容易实现但是需要输入完整路径形如由于和的关系不一般所以只需要直接导入包名即可这是最难的一个部分需要有等打包构建工具这就埋下了一个伏笔我们需要构建一个脚手架还有我个人更倾向用这里为了更好地验证包发布的效果这里可以使用工具来模拟验证比虚拟更直接的内容更新办法相比虚拟其实有个更简单且还算高效的办法一键替换内容这样的实现将会减小代码体积并且在常规情况下的效率会高于虚拟模块化受到腾讯的微前端框架无界的启发我们想到了一种不一样的模块化方案先到根目录下中写入根组件然后这里是模块这是组件怎么引入模块呢从根组件开始解析模板编译的过程访问每个节点时通过字符串比较发现了非原生标签那么我们就推断这是一个组件要求用户手写组件注册据此便能够通过组件名称即找到对应的文件路径用等方式请求下来异步解析非常高效也为提供了能力直接替换原来的组件标签的即可注意替换之后该组件内部可能还有组件也遵循上述规则进行解析这样的设计我们便以一种非常简单的方式实现了单页面应用组件化设计它的特点是渲染顺序是先序更新粒度是一个组件所以我们不需要并且更好的数据劫持初步实现将换为这样我们就能够在不重写方法的前提下监听到数组的等操作了这是一个改动量非常大的工作但是很显然它的收益是相当可观的多级调用还需要支持对象多级调用思路就是通过点来分割即可性能优化对于已经被劫持过的数据我们要防止其被再次劫持以避免不必要的性能开销更好的观察者模式现在的观察者都是不具名的存在很多性能问题一处变量改变时除了通知其他变量更新之外还会通知变量更新比如中反复改变状态时会创建大量重复的观察者优化的方案也比较简单将的数组改为一个通过键名指定更新某一个变量丰富语法现在已经实现了插值语法循环等目前还打算实现以下语法系列这是中非常优秀的一个设计抄了组件参数传递父级组件中子级组件中会把这个组件标签上所有的属性搜刮下来然后自动放到中之后将作为一个关键字不允许用户自定义叫另外还有的操作这个则是中非常符合直觉的设计父组件中这是嵌入的内容子组件中结合等语法可以实现非常多骚操作而且这部分由于是用直接插入的所以还可以使用子组件中的变量监听即让用户手动监听数据这个比较简单将观察者的内部方法暴露出去即可实现生命周期对此我们还得仔细思考一下到底是实现还是生命周期直接在挂载的时候加个函数就行了更多生态实现官方文档实现框架的路由实现快速搭建项目产出利用快速构建优秀的作品组件样式库暂时使用开源的可以先考虑发布上线测试点内容插值语法常规的基础数据插值如特殊的基础数据插值如空字符串基本数学运算表达式三元表达式对于和插值语法不解析其余均正常常规的引用数据类型插值如其中支持级连续调用但是的并没有生效已修复特殊的引用数据类型插值如空对象函数表达式函数运算结果新建对象对于函数表达式竟然会直接获取到运算结果出乎意料更多插值方式如直接插入表达式插入函数调用插入连续调用暂不打算支持插入表达式和函数调用非常极端的插值方式如不填写任何变量填写不存在的变量填写特殊符号填写标签很好填写标签也是能够如预期的一样进行两个对象内有相同的属性名字在插值语法的括号两侧写入其他内容如会把两侧的其他内容覆盖掉已修复属性插值语法常规的属性插值如其中不恰当的插值如属性需要或等类型的数据但是插入函数对象等更多插值方式如插入表达式插入函数调用连续调用同上暂不打算支持直接插入表达式和函数调用错误的插值如填写不存在的变量特殊符号标签系列由于和暂未上线所以暂时满足属性插值语法的标准即可判定为通过满足属性插值语法中的要求循环满足属性插值语法中的要求插入非数组元素对于形如的值会无法解析但是之前在中直接写函数表达式的话是能够解析返回值的所以这里后续最好统一一下另外最好再支持一下下标组件化参数传递满足属性插值语法中的要求远程组件只是试试能不能不作为必要的测试标准传递多个参数组件多级嵌套一个父组件多个子组件传递连续调用的对象传递函数是比较符合预期的能够实现组件通信不过有个问题是直接在宏任务中访问是大概是还没有加载上只能够异步地调用函数传递同一个变量以及改个名字之后重复传递特殊的组件调用如父子相互引用兄弟引用自己调用自己自己调用自己只会进行一次递归会被阻止父子相互引用被浏览器阻止子组件引用父组件失败兼容性移动端设备其他浏览器暂时不用管',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-07-20 08:59:01',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><!-- hexo injector head_end start --><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-double-row-display@1.00/cardlistpost.min.css"/>
<style>#recent-posts > .recent-post-item >.recent-post-info > .article-meta-wrap > .tags:before {content:"\A";
  white-space: pre;}#recent-posts > .recent-post-item >.recent-post-info > .article-meta-wrap > .tags > .article-meta__separator{display:none}</style>
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"></head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="not-top-img" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><div class="back-home-button"><i class="anzhiyufont anzhiyu-icon-grip-vertical"></i><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://kksj.cn" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/images.jpg" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://github.com/nihaokkjj" title="去我的github里面瞅瞅吧"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/cute.webp" alt="去我的github里面瞅瞅吧"/><span class="back-menu-item-text">去我的github里面瞅瞅吧</span></a></div></div></div></div><a id="site-name" href="/" accesskey="h"><div class="title">荥晋</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a><div id="he-plugin-simple"></div><script>var WIDGET = {
  "CONFIG": {
    "modules": "0124",
    "background": "2",
    "tmpColor": "FFFFFF",
    "tmpSize": "16",
    "cityColor": "FFFFFF",
    "citySize": "16",
    "aqiColor": "E8D87B",
    "aqiSize": "16",
    "weatherIconSize": "24",
    "alertIconSize": "18",
    "padding": "10px 10px 10px 10px",
    "shadow": "0",
    "language": "auto",
    "borderRadius": "20",
    "fixed": "true",
    "vertical": "top",
    "horizontal": "left",
    "left": "20",
    "top": "7.1",
    "key": "df245676fb434a0691ead1c63341cd94"
  }
}
</script><link rel="stylesheet" href="https://widget.qweather.net/simple/static/css/he-simple.css?v=1.4.0"/><script src="https://widget.qweather.net/simple/static/js/he-simple.js?v=1.4.0"></script></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size: 0.9em;"></i><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size: 0.9em;"></i><span> 留言板</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size: 0.9em;"></i><span> 闲言碎语</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size: 0.9em;"></i><span> 随便逛逛</span></a></li></ul></div></div></div><div id="nav-right"><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><input id="center-console" type="checkbox"/><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="/img/wchat.jpg" target="_blank"><img class="post-qr-code-img" alt="微信" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/wchat.jpg"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="/img/zhifubao.jpg" target="_blank"><img class="post-qr-code-img" alt="支付宝" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/zhifubao.jpg"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> 最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/Vue/" style="font-size: 1.05rem;">Vue<sup>1</sup></a><a href="/tags/blog/" style="font-size: 1.05rem;">blog<sup>2</sup></a><a href="/tags/minvue/" style="font-size: 1.05rem;">minvue<sup>1</sup></a><a href="/tags/node/" style="font-size: 1.05rem;">node<sup>1</sup></a><a href="/tags/%E5%89%8D%E7%AB%AF%E4%B8%89%E4%BB%B6%E5%A5%97/" style="font-size: 1.05rem;">前端三件套<sup>5</sup></a><a href="/tags/%E5%89%8D%E7%AB%AF%E5%AD%A6%E4%B9%A0%E8%B7%AF%E7%BA%BF/" style="font-size: 1.05rem;">前端学习路线<sup>1</sup></a><a href="/tags/%E6%89%8B%E6%9C%BA%E8%AE%BE%E7%BD%AE%E4%BB%A3%E7%90%86/" style="font-size: 1.05rem;">手机设置代理<sup>1</sup></a><a href="/tags/%E6%B2%A1%E6%9C%89%E8%90%A5%E5%85%BB%E7%9A%84%E8%AF%9D/" style="font-size: 1.05rem;">没有营养的话<sup>1</sup></a></div></div><hr/></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/07/"><span class="card-archive-list-date">July 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">6</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/06/"><span class="card-archive-list-date">June 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/04/"><span class="card-archive-list-date">April 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">6</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E8%BF%9B%E4%B8%80%E6%AD%A5%E5%AD%A6%E4%B9%A0vue/" itemprop="url">进一步学习vue</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/minvue/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>minvue</span></a></span></div></div><h1 class="post-title" itemprop="name headline">MinVue</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2025-04-01T00:00:00.000Z" title="发表于 2025-04-01 00:00:00">2025-04-01</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2025-07-20T08:59:01.928Z" title="更新于 2025-07-20 08:59:01">2025-07-20</time></span></div><div class="meta-secondline"><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为四川"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>四川</span></div></div></div><article class="post-content" id="article-container" itemscope itemtype="https://kkksj.cn/posts/2025/04/Fronted/MinVue/4a7e677b.html"><header><a class="post-meta-categories" href="/categories/%E8%BF%9B%E4%B8%80%E6%AD%A5%E5%AD%A6%E4%B9%A0vue/" itemprop="url">进一步学习vue</a><a href="/tags/minvue/" tabindex="-1" itemprop="url">minvue</a><h1 id="CrawlerTitle" itemprop="name headline">MinVue</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">匡思进</span><time itemprop="dateCreated datePublished" datetime="2025-04-01T00:00:00.000Z" title="发表于 2025-04-01 00:00:00">2025-04-01</time><time itemprop="dateCreated datePublished" datetime="2025-07-20T08:59:01.928Z" title="更新于 2025-07-20 08:59:01">2025-07-20</time></header><h1 id="Mini-Vue"><a href="#Mini-Vue" class="headerlink" title="Mini Vue"></a>Mini Vue</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在尝试读懂这篇文章之前，请保证已经学习过面向对象基本知识、HTML基础、JS基础，并且有过一定的实践开发基础，不然可能会有非常多的小问号。</p>
<p><strong>如果不满足上述条件，也可以试着读一读</strong>，不必为其中不懂的内容感到焦虑，后面都能学会的。</p>
<p>本文旨在教会读者实现一个精简版的Vue，很多Vue的功能会被简化，但是核心思想是相通的。</p>
<p>本文会尽可能通俗易懂、避开JS的各种生僻特性。</p>
<p>我们先不说Vue的事情，让我们先通过一些场景了解一点前置知识和概念——只需要知道大概是什么，没必要咬文嚼字：</p>
<h2 id="一个场景里的概念：响应式数据、依赖、数据劫持、MVVM-和双向绑定"><a href="#一个场景里的概念：响应式数据、依赖、数据劫持、MVVM-和双向绑定" class="headerlink" title="一个场景里的概念：响应式数据、依赖、数据劫持、MVVM 和双向绑定"></a>一个场景里的概念：响应式数据、依赖、数据劫持、MVVM 和双向绑定</h2><p>看看这段代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// 我们希望这个关系恒成立： y = 2 * x + 1 </span><br><span class="hljs-keyword">let</span> x = <span class="hljs-number">10</span> <br><span class="hljs-keyword">let</span> y = <span class="hljs-number">2</span> * x + <span class="hljs-number">1</span> <br>x = <span class="hljs-number">20</span> <br><span class="hljs-comment">// x变了，但是y却不会发生变化</span><br></code></pre></td></tr></table></figure>

<p>我们希望，x变化时y能自动地变化，而不是我们还需要手动赋值多此一举。</p>
<p>那么怎么实现呢？这里有一种思路是，设置一个角色专门监听x的变化，在察觉x变化时能够通知y发生变化。</p>
<p>这很容易做到，JS为我们提供了一个API，<code>Object.defineProperty</code>：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> data = &#123; <br>  <span class="hljs-attr">x</span>: <span class="hljs-number">10</span>, <br>  <span class="hljs-attr">y</span>: <span class="hljs-number">21</span> <br>&#125;; <br><br><span class="hljs-comment">// 监听 data.x 的 修改 </span><br><span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(data, <span class="hljs-string">&#x27;x&#x27;</span>, &#123; <br>  <span class="hljs-title function_">set</span>(<span class="hljs-params">value</span>) &#123; <br>    data.<span class="hljs-property">y</span> = value * <span class="hljs-number">2</span> + <span class="hljs-number">1</span>; <span class="hljs-comment">// 当 x 修改时，通知 y 发生相应变化 </span><br>  &#125; <br>&#125;); <br><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;一开始:&#x27;</span>, data.<span class="hljs-property">y</span>); <span class="hljs-comment">// 21 </span><br>data.<span class="hljs-property">x</span> = <span class="hljs-number">100</span>; <br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;x变化后:&#x27;</span>, data.<span class="hljs-property">y</span>); <span class="hljs-comment">// 201</span><br></code></pre></td></tr></table></figure>

<p>在Vue中，将普通数据变成响应式数据的过程，就叫<strong>数据劫持。</strong></p>
<p>而<code>Object.defineProperty</code>扮演的这个角色，在下文中被称为 <strong>数据劫持者（hijacker）</strong>。</p>
<p>回到web中，JS的DOM操作是如何去修改视图的呢？</p>
<p>让我们再看看一个DOM操作修改<code>&lt;input /&gt;</code>内容的例子：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">let</span> value = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">&#x27;input&#x27;</span>).<span class="hljs-property">value</span>; <span class="hljs-comment">// 1.获取input当前内容 </span><br><br>value = <span class="hljs-title class_">Number</span>(value) + <span class="hljs-number">1</span>; <span class="hljs-comment">// 2. 修改内容 </span><br><br><span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">&#x27;input&#x27;</span>).<span class="hljs-property">value</span> = value; <span class="hljs-comment">// 3.重新赋值</span><br></code></pre></td></tr></table></figure>

<p>我们能不能将第3步干掉？重新赋值看上去太多此一举了！</p>
<p>结合上文x和y的关系，相信大家应该是灵光一闪。</p>
<p>我们这里先抛出问题，暂时不考虑其中具体的实现细节。</p>
<p><strong>响应式数据</strong>指的是，依赖变化时，该数据会自动变化。如上文的y就是响应式数据，x则是其依赖，响应式数据和其依赖总是能表达为<code>y=F(x)</code>。</p>
<p><strong>M-V-VM</strong>是一种技术架构，<strong>M</strong>代表数据层(Model)，<strong>V</strong>代表视图层(View)，<strong>VM</strong>(ViewModel)在这里则是Vue代表的层次。</p>
<p>VM层会监听另外两层的变化，在其中一个变化时，使另外一个发生相应的变化，即VM层将V层和M层进行了<strong>双向绑定——V&#x3D;F1(M)且M&#x3D;F2(V),V与M互为依赖。</strong></p>
<p>具体一点：</p>
<ol>
<li>用户在输入框输入了123（V层），内存里与之关联的数据自动变为123（M层）</li>
<li>通过代码修改内存的数据为123（M层），界面上与之关联的部分自动变为123（V层）</li>
</ol>
<p>Vue通过建立MVVM架构实现了双向的响应式，即<strong>双向绑定</strong>。</p>
<hr>
<h2 id="又一个场景里的概念：观察者模式、依赖收集"><a href="#又一个场景里的概念：观察者模式、依赖收集" class="headerlink" title="又一个场景里的概念：观察者模式、依赖收集"></a>又一个场景里的概念：观察者模式、依赖收集</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript">  <span class="hljs-keyword">let</span> v = <span class="hljs-number">1</span>;</span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;v&#125;</span> /&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;v&#125;</span> /&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>上述HTML片段中，两个<code>&lt;input /&gt;</code>内使用了一个JS变量v。</p>
<p>我们实现一下对v变化的监听，察觉到它发生变化的时机，然后及时通知到两个<code>&lt;input /&gt;</code>的value改变：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// 监听v，一旦v变化，就改变两个input的值</span><br><span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(<span class="hljs-variable language_">window</span>, <span class="hljs-string">&#x27;v&#x27;</span>, <span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-title function_">set</span>(<span class="hljs-params">value</span>) &#123;<br>    <span class="hljs-keyword">const</span> inputDoms = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelectorAll</span>(<span class="hljs-string">&#x27;input&#x27;</span>)<br>    inputDoms[<span class="hljs-number">0</span>].<span class="hljs-property">value</span> = value<br>    inputDoms[<span class="hljs-number">1</span>].<span class="hljs-property">value</span> = value<br>  &#125;       <br>&#125;)<br></code></pre></td></tr></table></figure>

<p>注意，这里我们能进行通知，是因为这个片段很简单，我们能直接看到v被使用的位置，所以可以写像创建上文x与y的关系那样的代码。</p>
<p>但是，如果我们的项目有无穷多处都依赖了v, 那我们还能一个一个手动去实现每一个响应式数据吗？</p>
<p><strong>所以我们面临一个问题：怎么快速修改所有v？</strong></p>
<p>这里我们需要先学习业界大佬们总结的23种设计模式之一，<strong>观察者模式</strong>。</p>
<p>什么是观察者模式？</p>
<p>这个模式中一共有2个角色，<strong>发布者</strong>与<strong>观察者</strong>。</p>
<p>发布者好比一个UP主，观察者就是ta的粉丝，当UP发视频的时候，粉丝就会第一时间收到通知。</p>
<p>让我们用代码表述一下：</p>
<p>我们的问题解决了——<strong>怎么快速修改所有v:</strong></p>
<p><strong>通过发布者通知所有观察者执行<code>update</code>方法修改数据</strong>，<strong>就实现了修改所有v。</strong></p>
<p>我们可以手动创建一个发布者，但是新的问题是，<strong>我们该怎么创建观察者？</strong></p>
<p>让我们分析一下该怎么做，就像是把大象放进冰箱一样，凡事都只需要三步：</p>
<ol>
<li>观察局势，发现很多地方都使用了变量v，比如<code>&lt;input value=&#123;v&#125;&gt;</code></li>
<li><strong>特殊标记</strong>这些v的位置</li>
<li>让被标记的变量成为观察者</li>
</ol>
<p>怎么标记呢？那就是创造一种语法，比如<code>&lt;input value=&#123;v&#125;&gt;</code>中的<code>&#123;v&#125;</code>。</p>
<p>然后通过一些~~暴力~~巧妙的操作，遍历所有HTML，找到其中格式满足<code>&#123;xxx&#125;</code>的内容，将其变成观察者即可。</p>
<p>同时，我们会用巧妙的操作实现一种逻辑，<strong>在观察者产生的时候，它会主动关注发布者</strong>。</p>
<p>具体怎么操作，我们后面再谈。</p>
<p><strong>寻找被特殊标记的变量</strong>的过程，就是<strong>依赖收集</strong>；<strong>将标记变量转化为响应式</strong>的过程，就是<strong>数据劫持</strong>；</p>
<p>至此，我们实现了单向的响应式，在publisher的内容被修改时触发publish方法通知所有存在于HTML片段里面的observer一起修改——也就是完成了<code>V=F1(M)</code>。</p>
<p><strong>那双向绑定，<code>M=F2(V)</code>怎么实现呢？</strong></p>
<p>有了上述的铺垫之后就非常简单了！视图层(V层)的变动主要是来自于用户的<strong>输入</strong>（键盘输入、鼠标点击等），所以我们只需要监听一些用户操作事件就好，比如当用户输入时，让publisher进行通知就行了。</p>
<p>代码示意如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs javascript">&lt;div&gt;<br>  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;v&#125;</span> /&gt;</span></span> <span class="hljs-comment">// 用户在这里标签上进行输入</span><br>  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;v&#125;</span> /&gt;</span></span><br>&lt;/div&gt;<br><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="language-javascript"><span class="language-xml">  <span class="hljs-comment">// ... 省略一堆代码</span></span></span><br><span class="language-javascript"><span class="language-xml">  <span class="hljs-keyword">const</span> inputDom1 = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">&#x27;input&#x27;</span>)</span></span><br><span class="language-javascript"><span class="language-xml">  <span class="hljs-comment">// 监听键盘输入</span></span></span><br><span class="language-javascript"><span class="language-xml">  inputDom1.<span class="hljs-property">oninput</span> = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> &#123;</span></span><br><span class="language-javascript"><span class="language-xml">    <span class="hljs-comment">// 一旦用户进行输入，就让UP主（publisher）把新的值告诉其他所有粉丝（观察者）</span></span></span><br><span class="language-javascript"><span class="language-xml">    publisher.<span class="hljs-title function_">publish</span>(e.<span class="hljs-property">target</span>.<span class="hljs-property">value</span>)</span></span><br><span class="language-javascript"><span class="language-xml">  &#125;</span></span><br><span class="language-javascript"><span class="language-xml"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br></code></pre></td></tr></table></figure>

<hr>
<h2 id="再一个场景里的概念：虚拟DOM和Diff算法"><a href="#再一个场景里的概念：虚拟DOM和Diff算法" class="headerlink" title="再一个场景里的概念：虚拟DOM和Diff算法"></a>再一个场景里的概念：虚拟DOM和Diff算法</h2><p>让我们先来讲个故事：</p>
<p>某个疯狂星期四，乐程的xxl点外卖。打开某团先点了一份黄金鸡块，五分钟后，觉得不够吃又点了一份吮指原味鸡，再过了五分钟，觉得有点渴于是又点了一杯肥宅快乐水…</p>
<p>这个故事给我们什么启发？</p>
<p>很明显，这样多次操作下来，需要支付多次配送费用，显然不如一次性点完所有来得划算。</p>
<p><strong>在web中也是类似的</strong>：</p>
<p>JS引擎和处理HTML的渲染引擎不在同一个进程下，每当用JS去操作HTML（DOM操作），都需要开辟一个跨进程的通道，这种操作开销不小。</p>
<p>看不懂没关系，我们通俗一点说，</p>
<p>相当于，JS和HTML是不在同一个国家的，JS要去处理HTML相关的事情，就得花大价钱买机票出国去做，做完了又得买机票回来继续做自己的事情，如果下次又有HTML的事情要处理，那么就又得买机票出国…</p>
<p>这种开销是昂贵的。</p>
<p>所以，如果JS能先把要处理的DOM统一记录下来，之后一次性处理完，就能节省许多不必要的开销。</p>
<p>而这种记录，就是<strong>虚拟DOM。</strong></p>
<p>众所周知，HTML会被解析为DOM树，下图左侧HTML对应就是右侧的DOM树：</p>
<p>DOM这个词严格来说指的是DOM树，其中每个节点就叫DOM节点，而DOM元素专指标签。</p>
<p>但是口头上，DOM、DOM树、DOM节点这几个词经常混用，并不做严格的区分…</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
</table>
<p>我们为了更明确地表示区分，在提到<strong>虚拟DOM</strong>的语境下，会把DOM称为<strong>真实DOM。</strong></p>
<p>虚拟DOM就是用JS代码表示上图右侧结构(主要看a标签那一块的表示就好了)：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> visualDom = &#123; <br>    <span class="hljs-attr">tag</span>: <span class="hljs-string">&#x27;html&#x27;</span>,  <span class="hljs-comment">// 标签名 </span><br>    <span class="hljs-attr">props</span>: &#123;&#125;,    <span class="hljs-comment">// 标签的属性 </span><br>    <span class="hljs-attr">content</span>: [    <span class="hljs-comment">// 标签的内容 </span><br>        &#123; <br>            <span class="hljs-attr">tag</span>: <span class="hljs-string">&#x27;head&#x27;</span>, <br>            <span class="hljs-attr">props</span>: &#123;&#125;, <br>            <span class="hljs-attr">content</span>: [] <br>        &#125;, <br>        &#123; <br>            <span class="hljs-attr">tag</span>: <span class="hljs-string">&#x27;body&#x27;</span>, <br>            <span class="hljs-attr">props</span>: <span class="hljs-string">&#x27;&#x27;</span>, <br>            <span class="hljs-attr">content</span>: [ <br>                &#123; <br>                    <span class="hljs-attr">tag</span>: <span class="hljs-string">&#x27;a&#x27;</span>, <br>                    <span class="hljs-attr">props</span>: &#123; <br>                        <span class="hljs-attr">href</span>: <span class="hljs-string">&#x27;xxx&#x27;</span> <br>                    &#125;, <br>                    <span class="hljs-attr">content</span>: [ <br>                        <span class="hljs-string">&#x27;a的内容&#x27;</span> <span class="hljs-comment">// 内容可以直接就是一个字符串,所以后面需要区分,是字符串还是标签 </span><br>                    ] <br>                &#125;, <br>                <span class="hljs-string">&#x27;123&#x27;</span> <br>            ] <br>        &#125; <br>    ] <br>&#125;<br></code></pre></td></tr></table></figure>

<p>之后，每次JS先在自己家里把要做的改变记录好，后面出国就能一次性把所有事情办完，节省开销。</p>
<p>那么如何构建虚拟DOM呢？让我们一步一步考虑：</p>
<ol>
<li>起初，遍历所有真实DOM，产生上述结构。</li>
<li>当发送改变时，比如新增&#x2F;删除了一些标签，我们得先在虚拟DOM记录这种改变——<strong>这时候问题出现了</strong>！</li>
</ol>
<p>我们怎么知道这种<strong>改变发生在虚拟DOM的哪个位置</strong>？又重新遍历所有真实DOM节点产生新的结构吗？这听上去开销也太大了，甚至比我们使用虚拟DOM前的情况还要大，那这简直是得不偿失。</p>
<p>所以我们需要一些算法来优化一下，也就是<strong>Diff算法。</strong></p>
<p>Diff算法不是具体某个算法，而是像DP一样，是一类算法，解决的问题是如何尽快找出两份内容中不同的部分。</p>
<hr>
<h2 id="准备开始"><a href="#准备开始" class="headerlink" title="准备开始"></a>准备开始</h2><p>在了解了上面所有概念之后，我们最后来进行一点总结。</p>
<p>我们要做的是<strong>My-Vue</strong>，所以简称为<strong>MUE</strong>吧。</p>
<p>在正式开始之前，希望大家能先去体验一下真正的Vue。</p>
<p>由于Mue的语法模仿的是Vue2, 所以推荐大家选择Vue2进行体验。</p>
<p>因为Vue3语法发生了一些变化，可能会给大家带来一些困扰。</p>
<p><strong>但无论什么版本，底层原理还是基本一致的。</strong></p>
<p>**体验到什么程度？**只需要看看大概长啥样，自己再写一点响应式数据试一下就行了。</p>
<p>让我们梳理一下上面三个场景中提到的内容，整体流程大概是这样的：</p>
<p>其中需要注意的是，我们之前提到的观察者模式中，没有实现反向通知的能力，这点会在下文提及。</p>
<p>让我们准备一下文件结构：</p>
<p>其中<code>index.html</code>和<code>main.js</code>中的内容分别是：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Mue<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;app&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>&#123;msg&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;&#123;msg&#125;&quot;</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;module&quot;</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;./main.js&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>如果一切顺利，html中出现的<code>&#123;msg&#125;</code>将被替换成<code>Hello Mue</code>。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Mue</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;../mue-core/mue.js&#x27;</span>;<br><br><span class="hljs-variable language_">window</span>.<span class="hljs-property">mue</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Mue</span>(&#123;<br>  <span class="hljs-attr">el</span>: <span class="hljs-string">&#x27;#app&#x27;</span>,<br>  <span class="hljs-attr">data</span>: &#123;<br>    <span class="hljs-attr">msg</span>: <span class="hljs-string">&#x27;Hello MUE!&#x27;</span><br>  &#125;,<br>&#125;);<br></code></pre></td></tr></table></figure>

<p>和上文一样，接下来涉及到面向对象的部分，我们都用<strong>Class</strong>进行实现。</p>
<p>JS中，Class本质是Function，这意味着可以用Function实现——并且这是更推荐的做法。</p>
<p>但是考虑到大家的面向对象基础更多来自于Java，用Class实现应该更容易上手。</p>
<hr>
<h2 id="实现核心能力"><a href="#实现核心能力" class="headerlink" title="实现核心能力"></a>实现核心能力</h2><h3 id="实现：ViewModel层核心-Mue"><a href="#实现：ViewModel层核心-Mue" class="headerlink" title="实现：ViewModel层核心 Mue"></a>实现：ViewModel层核心 Mue</h3><p>非常简单，主要是记录一下<code>el</code>和<code>data</code>。</p>
<p><code>el</code>即对应的真实DOM节点，后续我们将把整个项目挂载到<code>el</code>上。</p>
<p>然后创建<strong>数据劫持者Hijacker</strong>和<strong>模板编译者Compiler</strong>即可。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Hijacker</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;../mue-core/hijacker.js&#x27;</span>;<br><span class="hljs-keyword">import</span> <span class="hljs-title class_">Compiler</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./compiler.js&#x27;</span>;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Mue</span> &#123;<br>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">options</span>) &#123;<br>    <span class="hljs-comment">// element的简写。作为项目挂载的根节点。</span><br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">el</span> = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(options.<span class="hljs-property">el</span>);<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span> = options.<span class="hljs-property">data</span>;<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hijacker</span>(<span class="hljs-variable language_">this</span>, <span class="hljs-string">&#x27;data&#x27;</span>);<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Compiler</span>(<span class="hljs-variable language_">this</span>); <span class="hljs-comment">// 把整个mue都传给Compiler</span><br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">Mue</span>;<br></code></pre></td></tr></table></figure>

<h3 id="实现：发布者-Publisher"><a href="#实现：发布者-Publisher" class="headerlink" title="实现：发布者 Publisher"></a>实现：发布者 Publisher</h3><p>比较简单，基本和之前提到的部分一致，不再过多赘述：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// 发布者</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Publisher</span> &#123;<br>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">data</span>) &#123;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">viewers</span> = [];<br>  &#125;<br><br>  <span class="hljs-title function_">addViewer</span>(<span class="hljs-params">viewer</span>) &#123;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">viewers</span>.<span class="hljs-title function_">push</span>(viewer);<br>  &#125;<br><br>  <span class="hljs-title function_">publish</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">viewers</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">viewer</span>) =&gt;</span> &#123;<br>      viewer.<span class="hljs-title function_">update</span>();<br>    &#125;);<br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">Publisher</span>;<br></code></pre></td></tr></table></figure>

<h3 id="实现：数据劫持者-Hijacker"><a href="#实现：数据劫持者-Hijacker" class="headerlink" title="实现：数据劫持者 Hijacker"></a>实现：数据劫持者 Hijacker</h3><p>考虑到大家的JS基础，我们这里先简单说明一个JS的知识点，<code>this</code>指向。</p>
<p>本文的目的不是学习<code>this</code>，所以只做<strong>不严谨且粗略的介绍</strong>。（如果你已经弄懂了<code>this</code>，请跳过这个部分）</p>
<p>上文已经用到过不少了，看到这里相信也也应该知道Class中的<code>this</code>大部分时候的意思就是”我自己”。</p>
<p>我们上文也提到了，Class本质是Function，而且Function内部也有<code>this</code>。</p>
<p>大部分情况下，**一个函数的<code>this</code>指向这个函数的调用者。**来看看下面这个例子：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// case 1：类的方法</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">A</span> &#123;<br>  <span class="hljs-title function_">testThis</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>);<br>  &#125;<br>&#125;<br><span class="hljs-keyword">new</span> <span class="hljs-title function_">A</span>().<span class="hljs-title function_">testThis</span>(); <span class="hljs-comment">// **A**</span><br><br><span class="hljs-comment">// case 2: 全局函数</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">B</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>);<br>&#125;<br><span class="hljs-title function_">B</span>(); <span class="hljs-comment">// (浏览器环境下)**window**。 因为这是window.B()的缩写</span><br><br><span class="hljs-comment">// case 3: 类的方法中使用全局函数</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">C</span> &#123;<br>  <span class="hljs-title function_">testThis</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-title function_">B</span>();<br>  &#125;<br>&#125;<br><span class="hljs-keyword">new</span> <span class="hljs-title function_">C</span>().<span class="hljs-title function_">testThis</span>(); <span class="hljs-comment">// (浏览器环境下)**window**, 因为还是 window.B()</span><br><br><span class="hljs-comment">// case 4: 为了让 类的方法中使用的全局函数 访问到 类的this, 我们需要这么改：</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">Dfunction</span>(<span class="hljs-params">that</span>) &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(that);<br>&#125;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Dclass</span> &#123;<br>  <span class="hljs-title function_">testThis</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">const</span> that = <span class="hljs-variable language_">this</span>; <span class="hljs-comment">// 这里多开一个变量的确是不必要的，这里这么做是为了**强调这种处理方式**</span><br>    <span class="hljs-title class_">Dfunction</span>(that);<br>  &#125;<br>&#125;<br><span class="hljs-keyword">new</span> <span class="hljs-title class_">Dclass</span>().<span class="hljs-title function_">testThis</span>(); <span class="hljs-comment">// Dclass</span><br></code></pre></td></tr></table></figure>

<p>另外，数据劫持还需要注意一个事情就是，可能出现下面这样树形的数据，所以我们需要进行一个遍历处理，这里我们采用递归实现。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> data = &#123;<br>    <span class="hljs-attr">a</span>: &#123;<br>        <span class="hljs-attr">aa</span>:<span class="hljs-number">123</span>,<br>        <span class="hljs-attr">ab</span>: &#123;<br>            <span class="hljs-attr">aba</span>: <span class="hljs-string">&#x27;hhh&#x27;</span><br>        &#125;<br>    &#125;,<br>    <span class="hljs-attr">b</span>: <span class="hljs-string">&#x27;aaaaaaa&#x27;</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>好了，现在让我们来实现<strong>Hijacker:</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Publisher</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./publisher.js&quot;</span>;<br><br><span class="hljs-comment">// 数据劫持者</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Hijacker</span> &#123;<br>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">mue, data</span>) &#123;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">hijack</span>(mue, data);<br>  &#125;<br><br>  <span class="hljs-comment">// Object.defineProperty劫持数据需要拿到 该数据节点 及 其父级对象</span><br>  <span class="hljs-title function_">hijack</span>(<span class="hljs-params">object, key</span>) &#123;<br>    <span class="hljs-comment">// **创建发布者**</span><br>    <span class="hljs-keyword">const</span> publisher = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Publisher</span>();<br>    <span class="hljs-keyword">let</span> value = object[key];<br><br>    <span class="hljs-keyword">if</span> (!value) &#123;<br>      <span class="hljs-keyword">return</span>;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> value === <span class="hljs-string">&#x27;object&#x27;</span>) &#123; <span class="hljs-comment">// 当前节点是树，递归;</span><br>      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(value).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">key</span>) =&gt;</span> &#123;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">hijack</span>(value, key);<br>      &#125;);<br>    &#125; <span class="hljs-keyword">else</span> &#123; <span class="hljs-comment">// 当前节点是叶子节点；object则是其父级节点</span><br>      <span class="hljs-comment">// **上文提到的知识点：JS的this指向**</span><br>      <span class="hljs-keyword">const</span> that = <span class="hljs-variable language_">this</span>;    <br>      <span class="hljs-comment">// **开始劫持数据**</span><br>      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperties</span>(object, value, &#123;<br>        <span class="hljs-comment">// **记住这个get, 这个很重要**</span><br>        <span class="hljs-title function_">get</span>(<span class="hljs-params"></span>) &#123;  <span class="hljs-comment">// **实现反向通知的核心步骤**，具体怎么回事在**实现Viewer时进一步说明**</span><br>          <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Publisher</span>.<span class="hljs-property">target</span>) &#123;<br>            publisher.<span class="hljs-title function_">addViewer</span>(<span class="hljs-title class_">Publisher</span>.<span class="hljs-property">target</span>);<br>          &#125;<br>          <span class="hljs-keyword">return</span> value;<br>        &#125;,<br>        <span class="hljs-title function_">set</span>(<span class="hljs-params">newValue</span>) &#123;<br>          <span class="hljs-keyword">if</span> (value === newValue) &#123; <span class="hljs-comment">// 防止死循环: 更新-&gt;触发publish-&gt;更新-&gt;...</span><br>            <span class="hljs-keyword">return</span><br>          &#125;<br>          value = newValue;<br>          that.<span class="hljs-title function_">hijack</span>(object, newValue); <span class="hljs-comment">// 提防一首新的数据是树形结构，递归一下</span><br>          publisher.<span class="hljs-title function_">publish</span>();<br>        &#125;<br>      &#125;);<br><br>    &#125;<br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">Hijacker</span>;<br></code></pre></td></tr></table></figure>

<h3 id="实现：观察者-Viewer"><a href="#实现：观察者-Viewer" class="headerlink" title="实现：观察者 Viewer"></a>实现：观察者 Viewer</h3><p>观察者也非常容易实现，只需要在之前提到过的代码上加一点点内容实现反向通知即可：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Publisher</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./publisher.js&quot;</span>;<br><br><span class="hljs-comment">// 观察者</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Viewer</span> &#123;<br>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">mue, dataKey, updateHandler</span>) &#123;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">mue</span> = mue; <span class="hljs-comment">// 传说中的vm层，即mue实例</span><br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">dataKey</span> = dataKey; <span class="hljs-comment">// 数据的键</span><br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">updateHandler</span> = updateHandler; <span class="hljs-comment">// 用来更新视图层(V层)的方法</span><br><br>    <span class="hljs-comment">// 这里是反向通知的关键操作：</span><br>    <span class="hljs-comment">// 绑定一个静态属性。相当于在Publisher内部创建一个“全局”变量，记录是哪个观察者触发的反向通知</span><br>    <span class="hljs-title class_">Publisher</span>.<span class="hljs-property">target</span> = <span class="hljs-variable language_">this</span>;<br>    <span class="hljs-comment">// 这里使用了 mue.data[dataKey]，**将触发劫持者设置的 get方法**：</span><br>    <span class="hljs-comment">// **反向通知 publisher邀请当前这个viewer成为观察者（也可以理解为viewer主动成为观察者）**</span><br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">oldValue</span> = mue.<span class="hljs-property">data</span>[dataKey];<br>    <span class="hljs-comment">// 结束，标记为空，释放内存</span><br>    <span class="hljs-title class_">Publisher</span>.<span class="hljs-property">target</span> = <span class="hljs-literal">null</span>;<br>  &#125;<br><br>  <span class="hljs-title function_">update</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">const</span> newValue = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mue</span>.<span class="hljs-property">data</span>[dataKey];<br>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">oldValue</span> === newValue) &#123; <span class="hljs-comment">// 同样地，没有更新就啥也不干</span><br>      <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <span class="hljs-comment">// 更新视图，实现 V = F1(M)</span><br>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">updateHandler</span>(newValue);<br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">Viewer</span>;<br></code></pre></td></tr></table></figure>

<p>让我们分析一下其中<code>Publisher.target</code>是一个什么操作：</p>
<p>在创建Viewer的时候，会给Publisher添加一个<strong>静态属性</strong><code>target</code>，记录一下当前是在创建哪个观察者。</p>
<p>静态属性可以理解为，在<code>Publisher</code>上创建的一个全局变量。</p>
<p>然后使用这个观察者对应的值时，会触发<code>get</code>方法，让观察者实例<code>publisher</code>将刚刚记录的观察者添加进观察者队列——看上去就像是<strong>观察者一创建就主动关注了发布者</strong>一样。</p>
<p>这里其实有个有意思的小知识点，就顺口提一句：<br><code>import</code>的内容是原数据的引用而不是拷贝，所以我们可以在<code>viewer.js</code>引入的<code>Publisher</code>上绑定新的值，然后在<code>hijacker.js</code>中访问到这些值。</p>
<h3 id="实现：模板编译者-Compiler"><a href="#实现：模板编译者-Compiler" class="headerlink" title="实现：模板编译者 Compiler"></a>实现：模板编译者 Compiler</h3><p>这个是五个角色中最难的一个部分了。</p>
<p>在开始写代码前我们仍然需要介绍一堆前置概念。</p>
<ol>
<li>首先我们要复习一下JS的DOM类型——<strong>请记住DOM也是有类型的</strong>，常见的类型如下表所示：</li>
</ol>
<table>
<thead>
<tr>
<th><strong>类型</strong></th>
<th><strong>说明</strong></th>
<th><strong>编号</strong></th>
<th><strong>图示参考</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>元素</strong></td>
<td><strong>每一个标签都是一个元素节点，如 <code>&lt;div&gt;</code> 、 <code>&lt;span&gt;</code></strong></td>
<td><strong>1</strong></td>
<td></td>
</tr>
<tr>
<td>属性</td>
<td><code>id</code> 、<code>class</code> 、<code>style</code>等</td>
<td>2</td>
<td></td>
</tr>
<tr>
<td><strong>文本</strong></td>
<td><strong>元素节点或属性节点中的文本内容</strong></td>
<td><strong>3</strong></td>
<td></td>
</tr>
<tr>
<td>注释</td>
<td>注释，比如``</td>
<td>8</td>
<td></td>
</tr>
<tr>
<td>文档</td>
<td>也叫根节点，即<code>document</code></td>
<td>9</td>
<td></td>
</tr>
</tbody></table>
<ol start="2">
<li>然后再让我们了解一下 <strong>伪数组</strong>。</li>
</ol>
<!-- end list -->

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// 伪数组也叫类数组，本质是对象，只不过键是0-N, 就像是下面这样</span><br><span class="hljs-keyword">const</span> objectArray = &#123;<br>    <span class="hljs-number">0</span>: <span class="hljs-string">&#x27;aaa&#x27;</span>,<br>    <span class="hljs-number">1</span>: <span class="hljs-string">&#x27;bbb&#x27;</span>,<br>    <span class="hljs-number">2</span>: <span class="hljs-string">&#x27;ccc&#x27;</span><br>&#125;<br><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(objectArray[<span class="hljs-number">0</span>]) <span class="hljs-comment">// aaa</span><br></code></pre></td></tr></table></figure>

<p>什么场景下会出现伪数组？</p>
<p>比如<code>document.querySelectorAll</code>的返回值、函数的<code>arguments</code>参数列表等都是伪数组。</p>
<ol start="3">
<li>如果要把伪数组变为数组，可以使用<strong>Array.from</strong>方法:</li>
</ol>
<!-- end list -->

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs javascript">&lt;div id=<span class="hljs-string">&quot;app&quot;</span>&gt;<br>  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>Hello<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span><br>  <span class="hljs-title class_">World</span><br>&lt;/div&gt;<br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="language-javascript"><span class="language-xml">  <span class="hljs-keyword">const</span> dom = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">&#x27;#app&#x27;</span>)</span></span><br><span class="language-javascript"><span class="language-xml">  <span class="hljs-keyword">const</span> children = dom.<span class="hljs-property">childNodes</span> <span class="hljs-comment">// **获取当前节点的所有子节点。可以以此进行前序遍历**</span></span></span><br><span class="language-javascript"><span class="language-xml">  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;伪数组&#x27;</span>, children)</span></span><br><span class="language-javascript"><span class="language-xml">  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;真数组&#x27;</span>, <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(children))</span></span><br><span class="language-javascript"><span class="language-xml"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br></code></pre></td></tr></table></figure>

<p>那为什么要把伪数组转为真数组呢？</p>
<p>因为伪数组是对象，不具有数组的某些方法，比如<code>push</code>和<code>pop</code>，许多场景下使用起来不方便。</p>
<p>那JS设计者为什么要搞出伪数组这种东西？</p>
<p>据JS之父自己坦白——“当初只用了十天就搞完了…现在看起来确实设计得太糙了…”</p>
<ol start="4">
<li>最后，我们需要简单认识一下<strong>正则表达式（regular expression）。</strong></li>
</ol>
<p>实现Compiler只会简单用到一点正则，所以这里只给出3种case给大家了解一下概念，不做过多深入:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> reg = <span class="hljs-regexp">/\&#123;(.+?)\&#125;/</span>; <span class="hljs-comment">// 正则表达式。这个能够匹配形如 &#123;xxx&#125; 的字符串, ()表示要获取的部分</span><br><span class="hljs-keyword">const</span> str = <span class="hljs-string">&#x27;这是&#123;msg&#125;&#x27;</span>;<br><br><span class="hljs-comment">// case 1: 用正则表达式去匹配字符串</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(reg.<span class="hljs-title function_">test</span>(str)); <span class="hljs-comment">// true</span><br><br><span class="hljs-comment">// case 2: 用字符串去匹配正则表达式</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(str.<span class="hljs-title function_">match</span>(reg)); <span class="hljs-comment">// [ &#x27;&#123;msg&#125;&#x27;, &#x27;msg&#x27;, index: 2, input: &#x27;这是&#123;msg&#125;&#x27;, ...]</span><br><br><span class="hljs-comment">// case 3: 替换匹配内容</span><br><span class="hljs-keyword">const</span> data = <span class="hljs-string">&#x27;swpu-lec, yyds&#x27;</span>;<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(str.<span class="hljs-title function_">replace</span>(reg, data));  <span class="hljs-comment">// 这是swpu-lec, yyds</span><br></code></pre></td></tr></table></figure>

<p>由于主题是Vue，而且正则又博大精深，所以限于篇幅此处不做更多介绍了。如果对此感兴趣，可以学习：<br><strong>[该类型的内容暂不支持下载]</strong></p>
<p>熟悉了以上内容后，先来大体看看我们要做的东西。</p>
<p>内容比较多，我们拆成了几个层次分开看，首先我们需要一个大体的框架如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Viewer</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./viewer.js&quot;</span>;<br><br><span class="hljs-comment">// 模板编译者</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Compiler</span> &#123;<br>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">mue</span>) &#123;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">mue</span> = mue;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">el</span> = mue.<span class="hljs-property">el</span>;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">compile</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">el</span>);<br>  &#125;<br><br>  <span class="hljs-comment">// 开始编译</span><br>  <span class="hljs-title function_">compile</span>(<span class="hljs-params">el</span>) &#123;<br>    <span class="hljs-keyword">const</span> childNodes = el.<span class="hljs-property">childNodes</span>; <span class="hljs-comment">// 真实DOM伪数组</span><br>    <span class="hljs-keyword">const</span> childNodesList = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(childNodes); <span class="hljs-comment">// 转为真数组，进而可以用数组的api</span><br><br>    <span class="hljs-comment">// 前序遍历整个DOM树</span><br>    childNodesList.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">node,</span>) =&gt;</span> &#123;<br>      <span class="hljs-comment">// 判断是什么类型的DOM, 扔给不同的处理方法</span><br>      <span class="hljs-keyword">if</span> (node.<span class="hljs-property">nodeType</span> === <span class="hljs-number">1</span>) &#123; <span class="hljs-comment">// 元素类型</span><br>        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">compileForElement</span>(node);<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (node.<span class="hljs-property">nodeType</span> === <span class="hljs-number">3</span>) &#123; <span class="hljs-comment">// 文本类型</span><br>        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">compileForText</span>(node);<br>      &#125;<br>      <span class="hljs-comment">// 如果还有子节点，递归获取下一层</span><br>      <span class="hljs-keyword">if</span> (node.<span class="hljs-property">childNodes</span>.<span class="hljs-property">length</span>) &#123;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">compile</span>(node);<br>      &#125;<br>    &#125;);<br>  &#125;<br>  <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> 主要就是实现这俩函数：</span><br>  <span class="hljs-comment">// 处理元素类型DOM</span><br>  <span class="hljs-title function_">compileForElement</span>(<span class="hljs-params">node</span>) &#123;&#125;<br>  <span class="hljs-comment">// 处理文本类型DOM</span><br>  <span class="hljs-title function_">compileForText</span>(<span class="hljs-params">node</span>) &#123;&#125;<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">Compiler</span>;<br></code></pre></td></tr></table></figure>

<p>怎么实现函数呢？既然我们都说过正则匹配了，那么也会用上吧：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// 处理元素类型DOM</span><br><span class="hljs-title function_">compileForElement</span>(<span class="hljs-params">node</span>) &#123;<br>  <span class="hljs-keyword">const</span> reg = <span class="hljs-regexp">/\&#123;(.+?)\&#125;/</span>; <span class="hljs-comment">// 正则表达式，匹配形如 &#123;xxx&#125; 的字符串</span><br>  <span class="hljs-keyword">const</span> allAttributes = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(node.<span class="hljs-property">attributes</span>); <span class="hljs-comment">// 将节点的所有属性，处理为数组</span><br><br>  <span class="hljs-comment">// 遍历数组，处理每个属性</span><br>  allAttributes.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">attribute</span>) =&gt;</span> &#123;<br>    <span class="hljs-comment">// 比如 data=&quot;&#123;msg&#125;&quot;, attribute.name就是&quot;data&quot;, attribute.value就是&quot;&#123;msg&#125;&quot;</span><br>    <span class="hljs-keyword">const</span> text = attribute.<span class="hljs-property">value</span>;<br>    <span class="hljs-keyword">const</span> matchRes = text.<span class="hljs-title function_">match</span>(reg);<br>    <span class="hljs-keyword">if</span> (matchRes) &#123; <span class="hljs-comment">// 如果包含形如 &#123;xxx&#125; 的部分</span><br>      <span class="hljs-keyword">const</span> dataKey = matchRes[<span class="hljs-number">1</span>];    <span class="hljs-comment">// 比如匹配的是&quot;&#123;msg&#125;&quot;, matchRes[1]就是&quot;msg&quot;</span><br><br>      <span class="hljs-comment">// 创建观察者，触发相关逻辑</span><br>      <span class="hljs-keyword">new</span> <span class="hljs-title class_">Viewer</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mue</span>, dataKey, <span class="hljs-function">(<span class="hljs-params">newValue</span>) =&gt;</span> &#123;<br>        node.<span class="hljs-property">textContent</span> = newValue;<br>      &#125;);<br><br>      <span class="hljs-keyword">const</span> newValue = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mue</span>.<span class="hljs-property">data</span>[dataKey];<br>      node.<span class="hljs-property">value</span> = text.<span class="hljs-title function_">replace</span>(reg, newValue); <span class="hljs-comment">// 将 &#123;xxx&#125; 替换为具体的值</span><br>      <span class="hljs-comment">// 监听键盘输入，完成双向绑定，M=F2(V)</span><br>      node.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;input&#x27;</span>, <span class="hljs-function">() =&gt;</span> &#123;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">mue</span>.<span class="hljs-property">data</span>[dataKey] = node.<span class="hljs-property">value</span>;<br>      &#125;);<br>    &#125;<br>  &#125;);<br><br>&#125;<br><br><span class="hljs-comment">// 处理文本类型DOM</span><br><span class="hljs-title function_">compileForText</span>(<span class="hljs-params">node</span>) &#123;<br>  <span class="hljs-keyword">const</span> reg = <span class="hljs-regexp">/\&#123;(.+?)\&#125;/</span>;<br>  <span class="hljs-keyword">const</span> text = node.<span class="hljs-property">textContent</span>;<br>  <span class="hljs-keyword">const</span> matchRes = text.<span class="hljs-title function_">match</span>(reg);<br><br>  <span class="hljs-keyword">if</span> (matchRes) &#123;  <span class="hljs-comment">// 与上面的方法基本上一样的逻辑</span><br>    <span class="hljs-keyword">const</span> dataKey = matchRes[<span class="hljs-number">1</span>];<br>    <span class="hljs-keyword">const</span> newText = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mue</span>.<span class="hljs-property">data</span>[dataKey];<br>    node.<span class="hljs-property">textContent</span> = text.<span class="hljs-title function_">replace</span>(reg, newText);<br><br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Viewer</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mue</span>, dataKey, <span class="hljs-function">(<span class="hljs-params">newText</span>) =&gt;</span> &#123;<br>      node.<span class="hljs-property">textContent</span> = newText;<br>    &#125;);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>至此，MUE已经基本完成了。可以打开HTML页面体验一下成果了！</p>
<p>但也再额外给一点开放性挑战，感兴趣可以做一做：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// challenge 1：if、else-if、else，当值为布尔或可以类型转换为布尔时，进行相应的渲染控制</span><br>&lt;div&gt;<br>  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">if</span>=<span class="hljs-string">&quot;&#123;false&#125;&quot;</span>&gt;</span>A<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">else-if</span>=<span class="hljs-string">&quot;&#123;0&#125;&quot;</span>&gt;</span>B<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">else</span>=<span class="hljs-string">&quot;&#123;true&#125;&quot;</span>&gt;</span>C<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>&lt;/div&gt;<br><span class="hljs-comment">// challenge 2：循环渲染, 其中arr是一个数组，element是其元素，index是其下标</span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">for</span>=<span class="hljs-string">&quot;i:arr&quot;</span>&gt;</span></span><br><span class="language-xml">  <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>&#123;i&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br></code></pre></td></tr></table></figure>

<hr>
<h2 id="【废弃】实现性能优化"><a href="#【废弃】实现性能优化" class="headerlink" title="~~【废弃】实现性能优化~~"></a>~~【废弃】实现性能优化~~</h2><p>我们不需要下述的性能优化方案——因为我们有了超越虚拟DOM性能的方案。</p>
<h3 id="实现：虚拟DOM"><a href="#实现：虚拟DOM" class="headerlink" title="~~实现：虚拟DOM~~"></a>~~实现：虚拟DOM~~</h3><p>~~经过一番体验后就发现，如果非常快速地输入中文的话，可能会导致双向绑定出错…~~</p>
<p>~~这是因为，目前我们是每输入一个字符都会触发一次真实DOM的更改，高频且大量的操作就可能超出浏览器处理数据的极限（输入频率超过浏览器最大渲染频率），出现数据和视图不一致的情况…~~</p>
<p>~~总结就是，太卡了，需要优化一下，那么就像是我们上文提到的，实现一下虚拟DOM。~~</p>
<h3 id="实现：Diff算法"><a href="#实现：Diff算法" class="headerlink" title="~~实现：Diff算法~~"></a>~~实现：Diff算法~~</h3><p>如果我们没有虚拟DOM，那么我们或许可以不使用Diff算法？</p>
<hr>
<h2 id="实现更多场景"><a href="#实现更多场景" class="headerlink" title="实现更多场景"></a>实现更多场景</h2><p>我突然意识到这不仅是一次尝试，更是一个开发真实可用的框架的好机会！</p>
<p>由于Mue名字寓意太明显了抄袭痕迹太重，所以正式版改名叫<strong>Mud</strong>吧，寓意非常丰富：</p>
<ol>
<li>实现思路借鉴了Vue，React(JSX)，Svelte等多个框架，是各种东西糊成的一坨</li>
<li>实现并不精致，但是容易被塑造成各种形状，朴素实用</li>
<li>泥巴里面可以催生出很多东西，以此为基础可以产生更多技术框架</li>
<li>出淤泥而不染</li>
</ol>
<p>（我的确是在自吹自擂）</p>
<h3 id="1-在多种模块化规范下使用Mud-js"><a href="#1-在多种模块化规范下使用Mud-js" class="headerlink" title="1. 在多种模块化规范下使用Mud.js"></a>1. 在多种模块化规范下使用Mud.js</h3><p>先简单介绍一下JS的模块化规范：</p>
<table>
<thead>
<tr>
<th>规范名称</th>
<th>说明</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td>umd</td>
<td>几乎是前端诞生以来，就有了雏形，但是一直到2009年左右才终于形成正式的规范</td>
<td><code>&lt;script src=&quot;xxx&quot; /&gt;</code> &lt;br&gt;像这样引入的就是umd包</td>
</tr>
<tr>
<td>cjs</td>
<td>NodeJS的伴生产物，也是2009年左右形成的规范</td>
<td><code>const a = require(&#39;a&#39;)</code> &lt;br&gt;<code>module.exports = &#123;&#125;</code> &lt;br&gt;像这样的导入、导出的则是cjs包</td>
</tr>
<tr>
<td>esm</td>
<td>ECMAScript官方2015年推出的规范，JS正统</td>
<td><code>import a from &#39;a&#39;</code> &lt;br&gt;<code>export default b</code> &lt;br&gt;像这样导入、导出的则是esm包</td>
</tr>
<tr>
<td>cmd和amd</td>
<td>2009年前后出现，现如今使用频率较低，不在本次兼容的范围内。</td>
<td>?（不详）</td>
</tr>
</tbody></table>
<p>我们将借助<strong>rollup</strong>的能力实现一套代码转变为多种规范的包。</p>
<p>在这之前你一定听说过webpack或者vite——不使用这些是因为它们太重了，我们这里只是需要简单地转变规范，所以轻量小巧的rollup就成了首选。</p>
<p>相信配置一套满足上述要求的rollup文件不会困扰大家，所以交由大家自行实现。</p>
<p>在打包完成后，引入不同规范的包：</p>
<p><strong>umd</strong></p>
<p>非常容易实现，但是需要输入完整路径（形如<code>../node_modules/mud/umd/index.js</code>）</p>
<p><strong>cjs</strong></p>
<p>由于node和node_modules的关系不一般，所以只需要<code>require</code>直接导入包名即可(<code>require(&#39;mud&#39;)</code>)</p>
<p><strong>esm</strong></p>
<p>这是最难的一个部分，需要有webpack等打包构建工具（这就埋下了一个伏笔——我们需要构建一个脚手架；还有，我个人更倾向用<code>vite</code>）</p>
<p>这里为了更好地验证包发布的效果，这里可以使用工具<strong>yalc</strong>来模拟验证。</p>
<h3 id="2-比虚拟DOM更直接的内容更新办法"><a href="#2-比虚拟DOM更直接的内容更新办法" class="headerlink" title="2. 比虚拟DOM更直接的内容更新办法"></a>2. 比虚拟DOM更直接的内容更新办法</h3><p>相比虚拟DOM，其实有个更简单且还算高效的办法——<code>innerHTML</code>。</p>
<p>一键替换内容。</p>
<p>这样的实现将会减小代码体积，并且在常规情况下的效率会高于虚拟DOM。</p>
<h3 id="3-模块化"><a href="#3-模块化" class="headerlink" title="3. 模块化"></a>3. 模块化</h3><p>受到腾讯的微前端框架<strong>无界</strong>的启发，我们想到了一种不一样的模块化方案：</p>
<p>先到根目录下<code>src/index.html</code>中写入（根组件）</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Mud.js<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">&quot;stylesheet&quot;</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;./index.css&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;app&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>&#123;msg&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;&#123;msg&#125;&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">component1</span> /&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;module&quot;</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;./xxx/Mud.js&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript"><span class="hljs-keyword">new</span> <span class="hljs-title class_">Mud</span>(&#123;</span><br><span class="language-javascript">  <span class="hljs-attr">el</span>: <span class="hljs-string">&#x27;#app&#x27;</span>,</span><br><span class="language-javascript">  <span class="hljs-attr">data</span>: &#123;</span><br><span class="language-javascript">    <span class="hljs-attr">msg</span>: <span class="hljs-string">&#x27;Hello Mud!&#x27;</span>,</span><br><span class="language-javascript">    <span class="hljs-attr">arr</span>: [<span class="hljs-string">&#x27;Someday&#x27;</span>, <span class="hljs-string">&#x27;I&#x27;</span>, <span class="hljs-string">&#x27;Will&#x27;</span>, <span class="hljs-string">&#x27;Be&#x27;</span>, <span class="hljs-string">&#x27;Like&#x27;</span>, <span class="hljs-string">&#x27;You&#x27;</span>],</span><br><span class="language-javascript">    <span class="hljs-attr">cnt</span>: <span class="hljs-number">1</span>,</span><br><span class="language-javascript">  &#125;,</span><br><span class="language-javascript"></span><br><span class="language-javascript">  <span class="hljs-attr">components</span>: &#123;</span><br><span class="language-javascript">    <span class="hljs-attr">component1</span>: <span class="hljs-string">&#x27;src/components/component1/index.html&#x27;</span></span><br><span class="language-javascript">  &#125;</span><br><span class="language-javascript">&#125;);</span><br><span class="language-javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">plus</span> = (<span class="hljs-params"></span>) =&gt; &#123;</span><br><span class="language-javascript">  mud.<span class="hljs-property">data</span>.<span class="hljs-property">cnt</span> ++</span><br><span class="language-javascript">&#125;</span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>然后这里是模块<code>src/components/component1/index.html</code>：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>这是组件<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript"> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Mud</span>(&#123;</span><br><span class="language-javascript">  <span class="hljs-attr">el</span>: <span class="hljs-string">&#x27;#component1&#x27;</span>,</span><br><span class="language-javascript">  <span class="hljs-attr">data</span>: &#123;&#125;,</span><br><span class="language-javascript">&#125;);       </span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>怎么引入模块呢？</p>
<ol>
<li>从根组件开始解析（模板编译的过程），访问每个DOM节点时，通过字符串比较发现了非原生标签，那么我们就推断这是一个Mud组件。</li>
<li>要求用户手写组件注册（<code>id: path</code>），据此便能够通过组件名称（即<code>id</code>），找到对应的文件路径，用ajax等方式请求下来（异步解析非常高效，也为ssr提供了能力），直接替换原来的组件标签的<code>innerHTML</code>即可。</li>
<li>注意，替换之后，该组件内部可能还有组件，也遵循上述规则进行解析——这样的设计，我们便以一种非常简单的方式实现了单页面应用、组件化设计，它的特点是渲染顺序是先序，更新粒度是一个组件——所以我们不需要Diff，并且…</li>
<li><strong>更好的数据劫持</strong></li>
</ol>
<h3 id="初步实现"><a href="#初步实现" class="headerlink" title="初步实现"></a>初步实现</h3><p>将<code>Object.defineProperty</code>换为<strong>Proxy</strong>，这样我们就能够在不重写方法的前提下监听到数组的<code>push</code>、<code>pop</code>等操作了。这是一个改动量非常大的工作，但是很显然，它的收益是相当可观的。</p>
<h3 id="多级调用"><a href="#多级调用" class="headerlink" title="多级调用"></a>多级调用</h3><p>还需要支持对象多级调用，思路就是通过点来分割即可。</p>
<h3 id="性能优化"><a href="#性能优化" class="headerlink" title="性能优化"></a>性能优化</h3><p>对于已经被劫持过的数据，我们要防止其被再次劫持以避免不必要的性能开销。</p>
<h3 id="5-【TODO】更好的观察者模式"><a href="#5-【TODO】更好的观察者模式" class="headerlink" title="5. 【TODO】更好的观察者模式"></a>5. 【TODO】更好的观察者模式</h3><p>现在的观察者都是不具名的，存在很多性能问题：</p>
<ol>
<li>一处变量a改变时，除了通知其他变量a更新之外，还会通知变量b更新。</li>
<li>比如<code>handleIf</code>中，反复改变状态时，会创建大量重复的观察者。</li>
</ol>
<p>优化的方案也比较简单，将Publisher的数组改为一个<strong>Set</strong>，通过键名指定更新某一个变量。</p>
<h3 id="6-丰富语法"><a href="#6-丰富语法" class="headerlink" title="6. 丰富语法"></a>6. 丰富语法</h3><p>现在已经实现了插值语法、<code>for</code>循环等，目前还打算实现以下语法。</p>
<p><strong>if系列</strong></p>
<p><code>If else-if else</code>，这是vue中非常优秀的一个设计，抄了。</p>
<p><strong>for</strong></p>
<p><strong>组件参数传递</strong></p>
<p>父级组件中：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">component1</span> <span class="hljs-attr">a</span>=<span class="hljs-string">&#123;xxx&#125;</span> /&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript"><span class="hljs-keyword">new</span> <span class="hljs-title class_">Mud</span>(&#123;</span><br><span class="language-javascript">    <span class="hljs-attr">data</span>: &#123;</span><br><span class="language-javascript">        <span class="hljs-attr">xxx</span>:<span class="hljs-number">1</span></span><br><span class="language-javascript">    &#125;</span><br><span class="language-javascript">&#125;)</span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>子级组件中：</p>
<p>会把这个组件标签上所有的属性搜刮下来，然后自动放到<code>props.data</code>中（之后，<code>props</code>将作为一个关键字，不允许用户自定义<code>data</code>叫<code>props</code>）：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span><br>    &#123;&#123;props.data.xxx&#125;&#125;<br><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript"><span class="hljs-keyword">new</span> <span class="hljs-title class_">Mud</span>(&#123;</span><br><span class="language-javascript">    <span class="hljs-attr">data</span>: &#123;&#125;,</span><br><span class="language-javascript">&#125;)</span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>另外还有<code>props.child</code>的操作，这个则是react中非常符合直觉的设计：</p>
<p>父组件中：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs javascript">&lt;component1 a=&#123;xxx&#125;&gt;<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>这是嵌入的内容<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>&lt;/component1&gt;<br><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-keyword">new</span> <span class="hljs-title class_">Mud</span>(&#123;</span></span><br><span class="language-javascript"><span class="language-xml">    <span class="hljs-attr">data</span>: &#123;</span></span><br><span class="language-javascript"><span class="language-xml">        <span class="hljs-attr">xxx</span>:<span class="hljs-number">1</span></span></span><br><span class="language-javascript"><span class="language-xml">    &#125;</span></span><br><span class="language-javascript"><span class="language-xml">&#125;)</span></span><br><span class="language-javascript"><span class="language-xml"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br></code></pre></td></tr></table></figure>

<p>子组件中：</p>
<p>结合<code>if</code>等语法可以实现非常多骚操作，而且这部分由于是用<code>innerHTML</code>直接插入的，所以还可以使用子组件中的变量。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs javascript">&lt;div&gt;<br>    &#123;&#123;props.<span class="hljs-property">child</span>&#125;&#125;<br>&lt;/div&gt;<br><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-keyword">new</span> <span class="hljs-title class_">Mud</span>(&#123;</span></span><br><span class="language-javascript"><span class="language-xml">    <span class="hljs-attr">data</span>: &#123;&#125;,</span></span><br><span class="language-javascript"><span class="language-xml">&#125;)</span></span><br><span class="language-javascript"><span class="language-xml"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br></code></pre></td></tr></table></figure>

<p><strong>Watch监听</strong></p>
<p>即让用户手动监听数据，这个比较简单，将观察者的内部方法暴露出去即可。</p>
<h3 id="7-实现生命周期"><a href="#7-实现生命周期" class="headerlink" title="7. 实现生命周期"></a>7. 实现生命周期</h3><p>对此，我们还得仔细思考一下，到底是实现Hook还是生命周期。</p>
<p><strong>onMounted</strong></p>
<p>直接在挂载的时候加个函数就行了。</p>
<h3 id="8-更多生态"><a href="#8-更多生态" class="headerlink" title="8. 更多生态"></a>8. 更多生态</h3><p><strong>实现Mud-Doc：Mud官方文档</strong></p>
<p><strong>【TODO】实现Root：Mud框架的路由</strong></p>
<p><strong>实现Mud-Cli：快速搭建Mud项目</strong></p>
<p><strong>【TODO】产出Mud-Demo：利用Mud快速构建优秀的作品</strong></p>
<p><strong>组件样式库</strong></p>
<p>~~暂时使用开源的xy-ui:<a target="_blank" rel="noopener" href="https://github.com/xboxyan~~">https://github.com/xboxyan~~</a></p>
<p>可以先考虑 semi-ui</p>
<p><strong>发布上线</strong></p>
<hr>
<h2 id="测试点"><a href="#测试点" class="headerlink" title="测试点"></a>测试点</h2><h3 id="1-内容插值语法"><a href="#1-内容插值语法" class="headerlink" title="1. 内容插值语法"></a>1. 内容插值语法</h3><ul>
<li><p>☑ 常规的基础数据插值，如<code>&#123;a&#125;</code></p>
</li>
<li><p>☑ 特殊的基础数据插值，如<code>NaN</code>，<code>undefined</code>，<code>null</code>，空字符串，<code>symbol</code>，基本数学运算表达式，三元表达式</p>
<blockquote>
<p>对于<code>undefined</code>和<code>symbol</code>，插值语法不解析，其余均正常。</p>
</blockquote>
</li>
<li><p>☑ 常规的引用数据类型插值，如<code>&#123;b&#125;</code>，其中<code>b=&#123;name: 1&#125;</code></p>
<blockquote>
<p>支持n级连续调用，但是Proxy的setter并没有生效（已修复）。</p>
</blockquote>
</li>
<li><p>☑ 特殊的引用数据类型插值，如空对象, 函数表达式，函数运算结果，<code>new</code>新建对象</p>
<blockquote>
<p>对于函数表达式，竟然会直接获取到运算结果，出乎意料。</p>
</blockquote>
</li>
<li><p>☑ 更多插值方式，如直接插入表达式，插入函数调用，插入连续调用</p>
<blockquote>
<p>暂不打算支持插入表达式和函数调用。</p>
</blockquote>
</li>
<li><p>☑ 非常极端的插值方式，如不填写任何变量，填写不存在的变量，填写特殊符号，填写标签</p>
<blockquote>
<p>很好，填写标签也是能够如预期的一样进行。</p>
</blockquote>
</li>
<li><p>☑ 两个对象内有相同的属性名字</p>
</li>
<li><p>☑ 在插值语法的括号两侧写入其他内容，如<code>aaaa&#123;a&#125;aa</code></p>
<blockquote>
<p>会把两侧的其他内容覆盖掉（已修复）。</p>
</blockquote>
</li>
</ul>
<h3 id="2-属性插值语法"><a href="#2-属性插值语法" class="headerlink" title="2. 属性插值语法"></a>2. 属性插值语法</h3><ul>
<li><p>☑ 常规的属性插值，如<code>input=&quot;&#123;a&#125;&quot;</code>，其中<code>a=1</code></p>
</li>
<li><p>☑ 不恰当的插值，如input属性需要<code>number</code>或<code>string</code>等类型的数据，但是插入函数、对象等</p>
</li>
<li><p>☑ 更多插值方式，如插入表达式，插入函数调用，连续调用</p>
<blockquote>
<p>同上，暂不打算支持直接插入表达式和函数调用。</p>
</blockquote>
</li>
<li><p>☑ 错误的插值，如填写不存在的变量，特殊符号，标签</p>
</li>
</ul>
<h3 id="3-if系列"><a href="#3-if系列" class="headerlink" title="3. if系列"></a>3. if系列</h3><p>（由于<code>if-else</code>和<code>else</code>暂未上线，所以暂时满足<strong>2.属性插值语法</strong>的标准即可判定为通过）</p>
<ul>
<li>☑ 满足<strong>2.属性插值语法</strong>中的要求</li>
</ul>
<h3 id="4-for循环"><a href="#4-for循环" class="headerlink" title="4. for循环"></a>4. for循环</h3><ul>
<li><p>☑ 满足<strong>2.属性插值语法</strong>中的要求</p>
</li>
<li><p>☑ 插入非数组元素</p>
<blockquote>
<p>对于形如<code>() =&gt; [1]</code>的值，会无法解析！</p>
</blockquote>
<blockquote>
<p>但是之前在<code>data</code>中直接写函数表达式的话，是能够解析返回值的，所以这里后续最好统一一下。</p>
</blockquote>
<blockquote>
<p>另外，最好再支持一下下标。</p>
</blockquote>
</li>
</ul>
<h3 id="5-组件化"><a href="#5-组件化" class="headerlink" title="5. 组件化"></a>5. 组件化</h3><ul>
<li><p>☑ 参数传递满足<strong>2.属性插值语法</strong>中的要求</p>
</li>
<li><p>☐ 远程组件</p>
<blockquote>
<p>只是试试能不能，不作为必要的测试标准。</p>
</blockquote>
</li>
<li><p>☑ 传递多个参数</p>
</li>
<li><p>☑ 组件多级嵌套</p>
</li>
<li><p>☑ 一个父组件多个子组件</p>
</li>
<li><p>☑ 传递连续调用的对象</p>
</li>
<li><p>☑ 传递函数</p>
<blockquote>
<p>是比较符合预期的，能够实现组件通信。</p>
</blockquote>
<blockquote>
<p>不过有个问题是，直接在<code>script</code>宏任务中访问<code>window.mud</code>是<code>undefined</code>，大概是还没有加载上。</p>
</blockquote>
<blockquote>
<p>只能够异步地调用函数。</p>
</blockquote>
</li>
<li><p>☑ 传递同一个变量，以及改个名字之后重复传递</p>
</li>
<li><p>☑ 特殊的组件调用，如父子相互引用，兄弟引用，自己调用自己</p>
<blockquote>
<p>自己调用自己：只会进行一次，递归会被阻止。</p>
</blockquote>
<blockquote>
<p>父子相互引用：被浏览器阻止，子组件引用父组件失败。</p>
</blockquote>
</li>
</ul>
<h3 id="6-兼容性"><a href="#6-兼容性" class="headerlink" title="6. 兼容性"></a>6. 兼容性</h3><ul>
<li>☑ 移动端设备</li>
<li>☑ Chrome&#x2F;Edge(其他浏览器暂时不用管)</li>
</ul>
</article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/cute.webp" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/cute.webp" title="头像" alt="头像"></a><div class="post-copyright__author_name">匡思进</div><div class="post-copyright__author_desc">荥晋的博客</div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="https://kkksj.cn/posts/2025/04/Fronted/MinVue/4a7e677b.html">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('https://kkksj.cn/posts/2025/04/Fronted/MinVue/4a7e677b.html')">MinVue</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"><div class="post-reward" onclick="anzhiyu.addRewardMask()"><div class="reward-button button--animated" title="赞赏作者"><i class="anzhiyufont anzhiyu-icon-hand-heart-fill"></i>打赏作者</div><div class="reward-main"><div class="reward-all"><span class="reward-title">感谢你赐予我前进的力量</span><ul class="reward-group"><li class="reward-item"><a href="/img/wchat.jpg" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/wchat.jpg" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="/img/zhifubao.jpg" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/zhifubao.jpg" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul><a class="reward-main-btn" href="/about/#about-reward" target="_blank"><div class="reward-text">赞赏者名单</div><div class="reward-dec">因为你们的支持让我意识到写文章的价值🙏</div></a></div></div></div><div id="quit-box" onclick="anzhiyu.removeRewardMask()" style="display: none"></div></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="https://kkksj.cn/posts/2025/04/Fronted/MinVue/4a7e677b.html"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=undefined&amp;url=https://kkksj.cn/posts/2025/04/Fronted/MinVue/4a7e677b.html&amp;pic=undefined" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl() {
  var currentPageUrl = window.location.href;
  var input = document.createElement("input");
  input.setAttribute("value", currentPageUrl);
  document.body.appendChild(input);
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand("copy");
  document.body.removeChild(input);
}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://kkksj.cn" target="_blank">荥晋</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/minvue/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>minvue<span class="tagsPageCount">1</span></a></div></div></div><div class="post_share"><div class="social-share" data-image="/img/9.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/2025/04/Fronted/%E5%AD%A6%E4%B9%A0%E6%97%A5%E8%AE%B0/c4f4b3de.html"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/10.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">前端学习日记</div></div></a></div><div class="next-post pull-right"><a href="/posts/2025/06/Fronted/node/857fe845.html"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/8.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">node</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/images.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-status"><img class="g-status" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://twikoo-magic.oss-cn-hangzhou.aliyuncs.com/Genshin/18.jpg" alt="status"/></div></div><div class="author-info__description"><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">这有关于<b style="color:#fff">产品、设计、开发</b>相关的问题和看法，还有<b style="color:#fff">文章翻译</b>和<b style="color:#fff">分享</b>。</div><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">相信你可以在这里找到对你有用的<b style="color:#fff">知识</b>和<b style="color:#fff">教程</b>。</div></div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/"><h1 class="author-info__name">匡思进</h1><div class="author-info__desc">荥晋的博客</div></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="https://github.com/nihaokkjj" target="_blank" title="Github"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-GitHub"></use></svg></a><a class="social-icon faa-parent animated-hover" href="https://space.bilibili.com/1276825147" target="_blank" title="BiliBili"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-BILIBILI"></use></svg></a></div></div></div></div><div class="card-widget anzhiyu-right-widget" id="card-wechat" onclick="null"><div id="flip-wrapper"><div id="flip-content"><div class="face" style="background: url(https://bu.dusays.com/2023/01/13/63c02edf44033.png) center center / 100% no-repeat"></div><div class="back face" style="background: url(https://bu.dusays.com/2023/05/13/645fa415e8694.png) center center / 100% no-repeat"></div></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Mini-Vue"><span class="toc-number">1.</span> <span class="toc-text">Mini Vue</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E4%B8%AA%E5%9C%BA%E6%99%AF%E9%87%8C%E7%9A%84%E6%A6%82%E5%BF%B5%EF%BC%9A%E5%93%8D%E5%BA%94%E5%BC%8F%E6%95%B0%E6%8D%AE%E3%80%81%E4%BE%9D%E8%B5%96%E3%80%81%E6%95%B0%E6%8D%AE%E5%8A%AB%E6%8C%81%E3%80%81MVVM-%E5%92%8C%E5%8F%8C%E5%90%91%E7%BB%91%E5%AE%9A"><span class="toc-number">1.2.</span> <span class="toc-text">一个场景里的概念：响应式数据、依赖、数据劫持、MVVM 和双向绑定</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%88%E4%B8%80%E4%B8%AA%E5%9C%BA%E6%99%AF%E9%87%8C%E7%9A%84%E6%A6%82%E5%BF%B5%EF%BC%9A%E8%A7%82%E5%AF%9F%E8%80%85%E6%A8%A1%E5%BC%8F%E3%80%81%E4%BE%9D%E8%B5%96%E6%94%B6%E9%9B%86"><span class="toc-number">1.3.</span> <span class="toc-text">又一个场景里的概念：观察者模式、依赖收集</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%8D%E4%B8%80%E4%B8%AA%E5%9C%BA%E6%99%AF%E9%87%8C%E7%9A%84%E6%A6%82%E5%BF%B5%EF%BC%9A%E8%99%9A%E6%8B%9FDOM%E5%92%8CDiff%E7%AE%97%E6%B3%95"><span class="toc-number">1.4.</span> <span class="toc-text">再一个场景里的概念：虚拟DOM和Diff算法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E5%BC%80%E5%A7%8B"><span class="toc-number">1.5.</span> <span class="toc-text">准备开始</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%A0%B8%E5%BF%83%E8%83%BD%E5%8A%9B"><span class="toc-number">1.6.</span> <span class="toc-text">实现核心能力</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%EF%BC%9AViewModel%E5%B1%82%E6%A0%B8%E5%BF%83-Mue"><span class="toc-number">1.6.1.</span> <span class="toc-text">实现：ViewModel层核心 Mue</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%EF%BC%9A%E5%8F%91%E5%B8%83%E8%80%85-Publisher"><span class="toc-number">1.6.2.</span> <span class="toc-text">实现：发布者 Publisher</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%EF%BC%9A%E6%95%B0%E6%8D%AE%E5%8A%AB%E6%8C%81%E8%80%85-Hijacker"><span class="toc-number">1.6.3.</span> <span class="toc-text">实现：数据劫持者 Hijacker</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%EF%BC%9A%E8%A7%82%E5%AF%9F%E8%80%85-Viewer"><span class="toc-number">1.6.4.</span> <span class="toc-text">实现：观察者 Viewer</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%EF%BC%9A%E6%A8%A1%E6%9D%BF%E7%BC%96%E8%AF%91%E8%80%85-Compiler"><span class="toc-number">1.6.5.</span> <span class="toc-text">实现：模板编译者 Compiler</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E3%80%90%E5%BA%9F%E5%BC%83%E3%80%91%E5%AE%9E%E7%8E%B0%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96"><span class="toc-number">1.7.</span> <span class="toc-text">~~【废弃】实现性能优化~~</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%EF%BC%9A%E8%99%9A%E6%8B%9FDOM"><span class="toc-number">1.7.1.</span> <span class="toc-text">~~实现：虚拟DOM~~</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%EF%BC%9ADiff%E7%AE%97%E6%B3%95"><span class="toc-number">1.7.2.</span> <span class="toc-text">~~实现：Diff算法~~</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%9B%B4%E5%A4%9A%E5%9C%BA%E6%99%AF"><span class="toc-number">1.8.</span> <span class="toc-text">实现更多场景</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%9C%A8%E5%A4%9A%E7%A7%8D%E6%A8%A1%E5%9D%97%E5%8C%96%E8%A7%84%E8%8C%83%E4%B8%8B%E4%BD%BF%E7%94%A8Mud-js"><span class="toc-number">1.8.1.</span> <span class="toc-text">1. 在多种模块化规范下使用Mud.js</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E6%AF%94%E8%99%9A%E6%8B%9FDOM%E6%9B%B4%E7%9B%B4%E6%8E%A5%E7%9A%84%E5%86%85%E5%AE%B9%E6%9B%B4%E6%96%B0%E5%8A%9E%E6%B3%95"><span class="toc-number">1.8.2.</span> <span class="toc-text">2. 比虚拟DOM更直接的内容更新办法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E6%A8%A1%E5%9D%97%E5%8C%96"><span class="toc-number">1.8.3.</span> <span class="toc-text">3. 模块化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9D%E6%AD%A5%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.8.4.</span> <span class="toc-text">初步实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%9A%E7%BA%A7%E8%B0%83%E7%94%A8"><span class="toc-number">1.8.5.</span> <span class="toc-text">多级调用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96"><span class="toc-number">1.8.6.</span> <span class="toc-text">性能优化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E3%80%90TODO%E3%80%91%E6%9B%B4%E5%A5%BD%E7%9A%84%E8%A7%82%E5%AF%9F%E8%80%85%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.8.7.</span> <span class="toc-text">5. 【TODO】更好的观察者模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-%E4%B8%B0%E5%AF%8C%E8%AF%AD%E6%B3%95"><span class="toc-number">1.8.8.</span> <span class="toc-text">6. 丰富语法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-%E5%AE%9E%E7%8E%B0%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="toc-number">1.8.9.</span> <span class="toc-text">7. 实现生命周期</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-%E6%9B%B4%E5%A4%9A%E7%94%9F%E6%80%81"><span class="toc-number">1.8.10.</span> <span class="toc-text">8. 更多生态</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E7%82%B9"><span class="toc-number">1.9.</span> <span class="toc-text">测试点</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%86%85%E5%AE%B9%E6%8F%92%E5%80%BC%E8%AF%AD%E6%B3%95"><span class="toc-number">1.9.1.</span> <span class="toc-text">1. 内容插值语法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%B1%9E%E6%80%A7%E6%8F%92%E5%80%BC%E8%AF%AD%E6%B3%95"><span class="toc-number">1.9.2.</span> <span class="toc-text">2. 属性插值语法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-if%E7%B3%BB%E5%88%97"><span class="toc-number">1.9.3.</span> <span class="toc-text">3. if系列</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-for%E5%BE%AA%E7%8E%AF"><span class="toc-number">1.9.4.</span> <span class="toc-text">4. for循环</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E7%BB%84%E4%BB%B6%E5%8C%96"><span class="toc-number">1.9.5.</span> <span class="toc-text">5. 组件化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-%E5%85%BC%E5%AE%B9%E6%80%A7"><span class="toc-number">1.9.6.</span> <span class="toc-text">6. 兼容性</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/2025/07/Fronted/Vue3/3a42db2d.html" title="Vue3"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/9.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Vue3"/></a><div class="content"><a class="title" href="/posts/2025/07/Fronted/Vue3/3a42db2d.html" title="Vue3">Vue3</a><time datetime="2025-07-01T00:00:00.000Z" title="发表于 2025-07-01 00:00:00">2025-07-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/2025/07/Fronted/%E5%89%8D%E7%AB%AF%E5%AD%A6%E4%B9%A0/4723d6e9.html" title="前端学习"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/7.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="前端学习"/></a><div class="content"><a class="title" href="/posts/2025/07/Fronted/%E5%89%8D%E7%AB%AF%E5%AD%A6%E4%B9%A0/4723d6e9.html" title="前端学习">前端学习</a><time datetime="2025-07-01T00:00:00.000Z" title="发表于 2025-07-01 00:00:00">2025-07-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/2025/07/blog/butterfly%E5%AE%89%E8%A3%85/e70f18fc.html" title="butterfly安装之旅"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/7.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="butterfly安装之旅"/></a><div class="content"><a class="title" href="/posts/2025/07/blog/butterfly%E5%AE%89%E8%A3%85/e70f18fc.html" title="butterfly安装之旅">butterfly安装之旅</a><time datetime="2025-07-01T00:00:00.000Z" title="发表于 2025-07-01 00:00:00">2025-07-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/2025/07/blog/%E9%AD%94%E6%94%B9%E4%B9%8B%E6%97%85/afacad78.html" title="魔改之旅"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/2.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="魔改之旅"/></a><div class="content"><a class="title" href="/posts/2025/07/blog/%E9%AD%94%E6%94%B9%E4%B9%8B%E6%97%85/afacad78.html" title="魔改之旅">魔改之旅</a><time datetime="2025-07-01T00:00:00.000Z" title="发表于 2025-07-01 00:00:00">2025-07-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/2025/07/%E5%A4%A7%E5%AD%A6%E7%94%9F%E6%B4%BB/%E9%9A%8F%E7%AC%94/3458e8f8.html" title="日记"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/1.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="日记"/></a><div class="content"><a class="title" href="/posts/2025/07/%E5%A4%A7%E5%AD%A6%E7%94%9F%E6%B4%BB/%E9%9A%8F%E7%AC%94/3458e8f8.html" title="日记">日记</a><time datetime="2025-07-01T00:00:00.000Z" title="发表于 2025-07-01 00:00:00">2025-07-01</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">&copy;2020 - 2025 By <a class="footer-bar-link" href="/" title="匡思进" target="_blank">匡思进</a></div></div><div id="footer-type-tips"></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="https://github.com/anzhiyu-c/hexo-theme-anzhiyu" title="主题">主题</a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">13</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">8</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">4</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://kksj.cn" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/images.jpg" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://github.com/nihaokkjj" title="去我的github里面瞅瞅吧"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/cute.webp" alt="去我的github里面瞅瞅吧"/><span class="back-menu-item-text">去我的github里面瞅瞅吧</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size: 0.9em;"></i><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size: 0.9em;"></i><span> 留言板</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size: 0.9em;"></i><span> 闲言碎语</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size: 0.9em;"></i><span> 随便逛逛</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/Vue/" style="font-size: 0.88rem;">Vue<sup>1</sup></a><a href="/tags/blog/" style="font-size: 0.88rem;">blog<sup>2</sup></a><a href="/tags/minvue/" style="font-size: 0.88rem;">minvue<sup>1</sup></a><a href="/tags/node/" style="font-size: 0.88rem;">node<sup>1</sup></a><a href="/tags/%E5%89%8D%E7%AB%AF%E4%B8%89%E4%BB%B6%E5%A5%97/" style="font-size: 0.88rem;">前端三件套<sup>5</sup></a><a href="/tags/%E5%89%8D%E7%AB%AF%E5%AD%A6%E4%B9%A0%E8%B7%AF%E7%BA%BF/" style="font-size: 0.88rem;">前端学习路线<sup>1</sup></a><a href="/tags/%E6%89%8B%E6%9C%BA%E8%AE%BE%E7%BD%AE%E4%BB%A3%E7%90%86/" style="font-size: 0.88rem;">手机设置代理<sup>1</sup></a><a href="/tags/%E6%B2%A1%E6%9C%89%E8%90%A5%E5%85%BB%E7%9A%84%E8%AF%9D/" style="font-size: 0.88rem;">没有营养的话<sup>1</sup></a></div></div><hr/></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="7593082970" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random" volume="0.7"></meting-js></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://i.y.qq.com/n2/m/share/details/taoge.html?id=7593082970&amp;hosteuin=&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.umd.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.5/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>// 消除控制台打印
var HoldLog = console.log;
console.log = function () {};
let now1 = new Date();
queueMicrotask(() => {
  const Log = function () {
    HoldLog.apply(console, arguments);
  }; //在恢复前输出日志
  const grt = new Date("07/0111/2025 00:00:00"); //此处修改你的建站时间或者网站上线时间
  now1.setTime(now1.getTime() + 250);
  const days = (now1 - grt) / 1000 / 60 / 60 / 24;
  const dnum = Math.floor(days);
  const ascll = [
    `欢迎使用安知鱼!`,
    `生活明朗, 万物可爱`,
    `
        
       █████╗ ███╗   ██╗███████╗██╗  ██╗██╗██╗   ██╗██╗   ██╗
      ██╔══██╗████╗  ██║╚══███╔╝██║  ██║██║╚██╗ ██╔╝██║   ██║
      ███████║██╔██╗ ██║  ███╔╝ ███████║██║ ╚████╔╝ ██║   ██║
      ██╔══██║██║╚██╗██║ ███╔╝  ██╔══██║██║  ╚██╔╝  ██║   ██║
      ██║  ██║██║ ╚████║███████╗██║  ██║██║   ██║   ╚██████╔╝
      ╚═╝  ╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝╚═╝   ╚═╝    ╚═════╝
        
        `,
    "已上线",
    dnum,
    "天",
    "©2020 By 安知鱼 V1.6.14",
  ];
  const ascll2 = [`NCC2-036`, `调用前置摄像头拍照成功，识别为【小笨蛋】.`, `Photo captured: `, `🤪`];

  setTimeout(
    Log.bind(
      console,
      `\n%c${ascll[0]} %c ${ascll[1]} %c ${ascll[2]} %c${ascll[3]}%c ${ascll[4]}%c ${ascll[5]}\n\n%c ${ascll[6]}\n`,
      "color:#425AEF",
      "",
      "color:#425AEF",
      "color:#425AEF",
      "",
      "color:#425AEF",
      ""
    )
  );
  setTimeout(
    Log.bind(
      console,
      `%c ${ascll2[0]} %c ${ascll2[1]} %c \n${ascll2[2]} %c\n${ascll2[3]}\n`,
      "color:white; background-color:#4fd953",
      "",
      "",
      'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%'
    )
  );

  setTimeout(Log.bind(console, "%c WELCOME %c 你好，小笨蛋.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(
      console,
      "%c ⚡ Powered by 安知鱼 %c 你正在访问 匡思进 的博客.",
      "color:white; background-color:#f0ad4e",
      ""
    )
  );

  setTimeout(Log.bind(console, "%c W23-12 %c 你已打开控制台.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(console, "%c S013-782 %c 你现在正处于监控中.", "color:white; background-color:#d9534f", "")
  );
});</script><script async src="/anzhiyu/random.js"></script><div class="js-pjax"><input type="hidden" name="page-type" id="page-type" value="post"></div><script>var visitorMail = "";
</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><script async src="https://at.alicdn.com/t/c/font_4976895_bnl7971qvi.js?spm=a313x.manage_type_myprojects.i1.10.73873a816pIoEr&amp;file=font_4976895_bnl7971qvi.js"></script><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/dist/fireworks.min.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>